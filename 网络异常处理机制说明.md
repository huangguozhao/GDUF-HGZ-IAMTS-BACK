# 网络异常处理机制说明

## 概述

当测试系统请求被测系统时，如果发生网络异常（连接失败、超时等），系统会自动将该测试用例标记为**失败（FAILED）**，并记录详细的错误信息。

## 支持的异常类型

### 1. 连接被拒绝 (CONNECTION_REFUSED)
**错误码：** -1

**发生场景：**
- 被测系统未启动或已停止
- 被测系统端口不正确
- 防火墙阻止了连接

**错误信息示例：**
```
连接被拒绝: 无法连接到 http://localhost:8085/api/auth/login，请检查被测系统是否启动
```

**处理方式：**
- 测试状态：FAILED
- 失败类型：CONNECTION_REFUSED
- 响应状态码：-1

### 2. 请求超时 (TIMEOUT)
**错误码：** -2

**发生场景：**
- 被测系统响应缓慢
- 网络延迟过高
- 超时时间设置过短

**错误信息示例：**
```
请求超时: 等待响应超过30秒，请检查被测系统性能或网络状态
```

**处理方式：**
- 测试状态：FAILED
- 失败类型：TIMEOUT
- 响应状态码：-2

### 3. 未知主机 (UNKNOWN_HOST)
**错误码：** -3

**发生场景：**
- 主机名拼写错误
- DNS无法解析该主机名
- 主机不存在或已下线

**错误信息示例：**
```
未知主机: 无法解析主机名 'invalid-host.com'，请检查URL配置
```

**处理方式：**
- 测试状态：FAILED
- 失败类型：UNKNOWN_HOST
- 响应状态码：-3

### 4. URL格式错误 (MALFORMED_URL)
**错误码：** -4

**发生场景：**
- URL格式不符合规范
- 缺少协议前缀（http://或https://）

**错误信息示例：**
```
URL格式错误: no protocol: localhost:8080/api/login
```

**处理方式：**
- 测试状态：FAILED
- 失败类型：MALFORMED_URL
- 响应状态码：-4

### 5. 协议错误 (PROTOCOL_ERROR)
**错误码：** -5

**发生场景：**
- HTTP方法不支持
- 协议版本不兼容

**错误信息示例：**
```
协议错误: Invalid HTTP method: INVALID
```

**处理方式：**
- 测试状态：FAILED
- 失败类型：PROTOCOL_ERROR
- 响应状态码：-5

### 6. SSL证书错误 (SSL_ERROR)
**错误码：** -6

**发生场景：**
- SSL证书无效或已过期
- SSL证书不受信任
- 证书与域名不匹配

**错误信息示例：**
```
SSL证书错误: PKIX path building failed，请检查HTTPS配置
```

**处理方式：**
- 测试状态：FAILED
- 失败类型：SSL_ERROR
- 响应状态码：-6

### 7. 网络IO错误 (IO_ERROR)
**错误码：** -7

**发生场景：**
- 网络连接中断
- 数据传输失败

**错误信息示例：**
```
网络IO错误: Connection reset by peer
```

**处理方式：**
- 测试状态：FAILED
- 失败类型：IO_ERROR
- 响应状态码：-7

### 8. 未知错误 (UNKNOWN_ERROR)
**错误码：** -99

**发生场景：**
- 其他未预期的错误

**错误信息示例：**
```
未知错误: Unexpected exception occurred
```

**处理方式：**
- 测试状态：FAILED
- 失败类型：UNKNOWN_ERROR
- 响应状态码：-99

## 处理流程

### 1. 发送HTTP请求

```java
HttpClientUtils.sendRequest(method, url, headers, body, timeout)
```

### 2. 捕获异常

```java
try {
    // 发送请求
} catch (ConnectException e) {
    // 连接被拒绝
    return new HttpResponseResult(-1, null, null, errorMsg);
} catch (SocketTimeoutException e) {
    // 请求超时
    return new HttpResponseResult(-2, null, null, errorMsg);
} catch (UnknownHostException e) {
    // 未知主机
    return new HttpResponseResult(-3, null, null, errorMsg);
}
// ... 其他异常
```

### 3. 检查错误并标记失败

```java
if (response.hasError()) {
    // 设置测试状态为FAILED
    executionDTO.setExecutionStatus(ExecutionStatusEnum.FAILED.getCode());
    executionDTO.setFailureMessage(response.getErrorMessage());
    
    // 根据错误码确定失败类型
    String failureType = determineFailureType(response.getStatusCode());
    executionDTO.setFailureType(failureType);
    
    // 生成详细错误日志
    String errorLog = generateNetworkErrorLog(...);
    executionDTO.setExecutionLogs(errorLog);
    
    return executionDTO;
}
```

### 4. 保存到数据库

```java
TestCaseResult result = new TestCaseResult();
result.setStatus("failed");
result.setFailureType("CONNECTION_REFUSED");
result.setFailureMessage("连接被拒绝: ...");
result.setExecutionLogs(errorLog);
```

## 错误日志格式

当发生网络错误时，系统会生成详细的错误日志：

```
=== 网络错误执行日志 ===
用例ID: 1
用例名称: 正常登录测试
执行时间: 2025-10-23T15:30:00

=== 请求信息 ===
请求方法: POST
请求URL: http://localhost:8085/api/auth/login
超时设置: 30秒
请求头: 
  Content-Type: application/json
  Accept: application/json
请求体: {"username":"admin","password":"123456"}

=== 错误信息 ===
错误类型: CONNECTION_REFUSED
错误代码: -1
错误信息: 连接被拒绝: 无法连接到 http://localhost:8085/api/auth/login，请检查被测系统是否启动

=== 失败说明 ===
连接被拒绝，可能原因：
  1. 被测系统未启动或已停止
  2. 被测系统端口不正确
  3. 防火墙阻止了连接
  建议：检查被测系统是否正在运行，确认URL和端口配置是否正确

=== 执行结果 ===
执行状态: FAILED
测试结论: 由于网络错误，此测试用例标记为失败
```

## 数据库记录

### TestCaseResults表

| 字段 | 值（网络错误示例） | 说明 |
|------|------------------|------|
| status | "failed" | 测试状态为失败 |
| failure_type | "CONNECTION_REFUSED" | 失败类型 |
| failure_message | "连接被拒绝: ..." | 错误信息 |
| http_response_status | -1 | 错误码 |
| http_response_body | null | 无响应体 |
| http_response_headers | null | 无响应头 |
| execution_logs | "=== 网络错误执行日志 ===" | 详细日志 |
| duration | 0 或实际耗时 | 执行耗时 |

### TestExecutionRecords表

执行完成后更新统计信息：

```sql
UPDATE TestExecutionRecords SET
    failed_cases = failed_cases + 1,
    executed_cases = executed_cases + 1,
    success_rate = (passed_cases / total_cases * 100)
WHERE record_id = ?;
```

## API响应格式

### 接口测试执行结果

```json
{
  "code": 0,
  "msg": "接口测试执行完成",
  "data": {
    "totalCases": 5,
    "passed": 3,
    "failed": 2,  // 包含网络错误的用例
    "successRate": 60.00,
    "caseResults": [
      {
        "caseId": 1,
        "caseName": "正常登录测试",
        "status": "failed",
        "failureMessage": "连接被拒绝: 无法连接到 http://localhost:8085/api/auth/login，请检查被测系统是否启动",
        "duration": 0,
        "logsLink": "/api/test-results/100/logs"
      }
    ]
  }
}
```

### 查看详细日志

```
GET /api/test-results/{execution_id}/logs
```

响应：
```
=== 网络错误执行日志 ===
用例ID: 1
用例名称: 正常登录测试
...（完整的错误日志）
```

## 配置说明

### 超时时间配置

**全局默认超时：** 30秒

**接口级别配置：**
```sql
UPDATE Apis SET timeout_seconds = 60 WHERE api_id = 1;
```

**测试用例级别配置：**
```sql
UPDATE TestCases SET timeout_seconds = 45 WHERE case_id = 1;
```

**优先级：**
```
测试用例超时 > 接口超时 > 全局默认超时
```

### 重试机制（未来扩展）

当前版本不支持自动重试，网络错误会直接标记为失败。

未来可扩展：
- 配置重试次数
- 配置重试间隔
- 只重试特定类型的错误（如超时）

## 监控和告警

### 建议的监控指标

1. **网络错误率**
   ```sql
   SELECT 
       COUNT(CASE WHEN failure_type LIKE '%NETWORK%' OR failure_type LIKE '%CONNECTION%' OR failure_type LIKE '%TIMEOUT%' THEN 1 END) * 100.0 / COUNT(*) as network_error_rate
   FROM TestCaseResults
   WHERE start_time >= NOW() - INTERVAL 1 HOUR;
   ```

2. **各类网络错误统计**
   ```sql
   SELECT 
       failure_type,
       COUNT(*) as count,
       COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () as percentage
   FROM TestCaseResults
   WHERE status = 'failed' 
       AND failure_type IN ('CONNECTION_REFUSED', 'TIMEOUT', 'UNKNOWN_HOST', 'SSL_ERROR')
   GROUP BY failure_type
   ORDER BY count DESC;
   ```

3. **超时用例分析**
   ```sql
   SELECT 
       tc.name,
       COUNT(*) as timeout_count
   FROM TestCaseResults tcr
   JOIN TestCases tc ON tcr.ref_id = tc.case_id
   WHERE tcr.failure_type = 'TIMEOUT'
       AND tcr.start_time >= NOW() - INTERVAL 7 DAY
   GROUP BY tc.case_id, tc.name
   ORDER BY timeout_count DESC
   LIMIT 10;
   ```

## 最佳实践

### 1. 合理设置超时时间

```java
// 快速接口：5-10秒
timeout: 10

// 普通接口：30秒（推荐）
timeout: 30

// 慢接口：60秒
timeout: 60

// 特殊场景：120秒（不推荐超过此值）
timeout: 120
```

### 2. 测试前检查被测系统

在执行测试前，确保：
- ✅ 被测系统已启动
- ✅ 被测系统可访问
- ✅ 网络连接正常

### 3. 错误分析

定期分析网络错误：
- 如果**CONNECTION_REFUSED**频繁出现 → 检查被测系统稳定性
- 如果**TIMEOUT**频繁出现 → 检查被测系统性能或增加超时时间
- 如果**UNKNOWN_HOST**出现 → 检查环境配置

### 4. 环境隔离

不同环境使用不同的超时配置：
- **开发环境**：短超时（10秒）
- **测试环境**：标准超时（30秒）
- **生产环境**：长超时（60秒）

## 故障排查

### 问题1：频繁超时

**现象：** 很多测试用例都因为超时而失败

**可能原因：**
1. 被测系统性能问题
2. 网络延迟高
3. 超时设置过短

**解决方案：**
1. 检查被测系统日志，确认是否有性能问题
2. 增加超时时间
3. 优化测试用例，减少复杂操作

### 问题2：所有测试用例都连接失败

**现象：** 所有测试都返回CONNECTION_REFUSED

**可能原因：**
1. 被测系统未启动
2. 被测系统端口配置错误
3. 防火墙阻止

**解决方案：**
1. 启动被测系统
2. 检查环境配置中的URL和端口
3. 检查防火墙规则

### 问题3：SSL证书错误

**现象：** HTTPS接口返回SSL_ERROR

**可能原因：**
1. SSL证书无效
2. 证书不受信任

**解决方案：**
1. 使用有效的SSL证书
2. 在开发环境可以考虑禁用SSL验证（不推荐生产环境）

## 总结

### 核心机制

```
请求被测系统
    ↓
发生网络异常？
    ↓
YES → 捕获异常
    ↓
确定错误类型（-1到-99）
    ↓
标记测试为FAILED
    ↓
生成详细错误日志
    ↓
保存到数据库
    ↓
返回失败结果
```

### 关键特性

- ✅ **自动捕获**：所有网络异常都会被自动捕获
- ✅ **详细分类**：8种常见网络错误类型
- ✅ **清晰日志**：详细的错误日志和失败说明
- ✅ **准确统计**：失败的测试用例会被正确计入统计
- ✅ **易于排查**：提供可能原因和建议解决方案

### 设计原则

1. **失败快速**：网络错误立即返回，不浪费时间
2. **信息完整**：记录所有相关信息，便于问题定位
3. **用户友好**：提供清晰的错误说明和建议
4. **数据准确**：正确更新测试统计信息

