<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.victor.iatms.mappers.TestExecutionMapper">

    <!-- 鏍规嵁鐢ㄤ緥ID鏌ヨ鐢ㄤ緥鎵ц淇℃伅 -->
    <select id="findTestCaseForExecution" resultType="com.victor.iatms.entity.dto.TestCaseExecutionDTO">
        SELECT 
            tc.case_id,
            tc.case_code,
            tc.name,
            tc.description,
            tc.priority,
            tc.severity,
            tc.tags,
            tc.pre_conditions,
            tc.test_steps,
            tc.request_override,
            tc.expected_http_status,
            tc.expected_response_schema,
            tc.expected_response_body,
            tc.assertions,
            tc.extractors,
            tc.validators,
            tc.is_enabled,
            tc.version,
            a.api_id AS 'apiInfo.apiId',
            a.api_code AS 'apiInfo.apiCode',
            a.name AS 'apiInfo.name',
            a.method AS 'apiInfo.method',
            a.path AS 'apiInfo.path',
            a.base_url AS 'apiInfo.baseUrl',
            a.full_url AS 'apiInfo.fullUrl',
            a.request_parameters AS 'apiInfo.requestParameters',
            a.path_parameters AS 'apiInfo.pathParameters',
            a.request_headers AS 'apiInfo.requestHeaders',
            a.request_body AS 'apiInfo.requestBody',
            a.request_body_type AS 'apiInfo.requestBodyType',
            a.response_body_type AS 'apiInfo.responseBodyType',
            a.description AS 'apiInfo.description',
            a.status AS 'apiInfo.status',
            a.version AS 'apiInfo.version',
            a.timeout_seconds AS 'apiInfo.timeoutSeconds',
            a.auth_type AS 'apiInfo.authType',
            a.auth_config AS 'apiInfo.authConfig',
            a.tags AS 'apiInfo.tags',
            a.examples AS 'apiInfo.examples'
        FROM TestCases tc
        LEFT JOIN Apis a ON tc.api_id = a.api_id
        WHERE tc.case_id = #{caseId}
        AND tc.is_deleted = FALSE
        AND tc.is_enabled = TRUE
        AND a.is_deleted = FALSE
        AND a.status = 'active'
    </select>

    <!-- 鎻掑叆娴嬭瘯缁撴灉 -->
    <insert id="insertTestCaseResult" parameterType="com.victor.iatms.entity.po.TestCaseResult" useGeneratedKeys="true" keyProperty="resultId">
        INSERT INTO TestCaseResults (
            execution_record_id, report_id, execution_id, task_type, ref_id, full_name, status, duration,
            start_time, end_time, failure_message, failure_trace, failure_type, error_code,
            steps_json, parameters_json, attachments_json, logs_link, screenshot_link, video_link,
            environment, browser, os, device, tags_json, severity, priority, retry_count, flaky,
            case_id, case_code, case_name, module_name, api_name, suite_name, package_name,
            epic_name, feature_name, story_name, test_layer, test_type, flaky_count, last_flaky_time,
            history_trend, custom_labels, root_cause_analysis, impact_assessment, retest_result, retest_notes,
            created_at, is_deleted
        ) VALUES (
            #{executionRecordId}, #{reportId}, #{executionId}, #{taskType}, #{refId}, #{fullName}, #{status}, #{duration},
            #{startTime}, #{endTime}, #{failureMessage}, #{failureTrace}, #{failureType}, #{errorCode},
            #{stepsJson}, #{parametersJson}, #{attachmentsJson}, #{logsLink}, #{screenshotLink}, #{videoLink},
            #{environment}, #{browser}, #{os}, #{device}, #{tagsJson}, #{severity}, #{priority}, #{retryCount}, #{flaky},
            #{caseId}, #{caseCode}, #{caseName}, #{moduleName}, #{apiName}, #{suiteName}, #{packageName},
            #{epicName}, #{featureName}, #{storyName}, #{testLayer}, #{testType}, #{flakyCount}, #{lastFlakyTime},
            #{historyTrend}, #{customLabels}, #{rootCauseAnalysis}, #{impactAssessment}, #{retestResult}, #{retestNotes},
            NOW(), FALSE
        )
    </insert>

    <!-- 鎻掑叆娴嬭瘯鎶ュ憡姹囨€?-->
    <insert id="insertTestReportSummary" parameterType="com.victor.iatms.entity.po.TestReportSummary" useGeneratedKeys="true" keyProperty="reportId">
        INSERT INTO TestReportSummaries (
            report_name, report_type, execution_id, project_id, environment, start_time, end_time, duration,
            total_cases, executed_cases, passed_cases, failed_cases, broken_cases, skipped_cases, success_rate,
            total_duration, avg_duration, max_duration, min_duration, report_status, file_format, file_path,
            file_size, download_url, generated_by, tags_json, summary_json, trend_data_json,
            report_config_id, iso_metrics, executive_summary, conclusion_recommendation,
            risk_assessment, defect_analysis, environment_details, test_scope_details,
            created_at, updated_at, is_deleted
        ) VALUES (
            #{reportName}, #{reportType}, #{executionId}, #{projectId}, #{environment}, #{startTime}, #{endTime}, #{duration},
            #{totalCases}, #{executedCases}, #{passedCases}, #{failedCases}, #{brokenCases}, #{skippedCases}, #{successRate},
            #{totalDuration}, #{avgDuration}, #{maxDuration}, #{minDuration}, #{reportStatus}, #{fileFormat}, #{filePath},
            #{fileSize}, #{downloadUrl}, #{generatedBy}, #{tagsJson}, #{summaryJson}, #{trendDataJson},
            #{reportConfigId}, #{isoMetrics}, #{executiveSummary}, #{conclusionRecommendation},
            #{riskAssessment}, #{defectAnalysis}, #{environmentDetails}, #{testScopeDetails},
            NOW(), NOW(), FALSE
        )
    </insert>

    <!-- 鏇存柊娴嬭瘯鎶ュ憡姹囨€?-->
    <update id="updateTestReportSummary" parameterType="com.victor.iatms.entity.po.TestReportSummary">
        UPDATE TestReportSummaries SET
            report_name = #{reportName},
            report_type = #{reportType},
            execution_id = #{executionId},
            project_id = #{projectId},
            environment = #{environment},
            start_time = #{startTime},
            end_time = #{endTime},
            duration = #{duration},
            total_cases = #{totalCases},
            executed_cases = #{executedCases},
            passed_cases = #{passedCases},
            failed_cases = #{failedCases},
            broken_cases = #{brokenCases},
            skipped_cases = #{skippedCases},
            success_rate = #{successRate},
            total_duration = #{totalDuration},
            avg_duration = #{avgDuration},
            max_duration = #{maxDuration},
            min_duration = #{minDuration},
            report_status = #{reportStatus},
            file_format = #{fileFormat},
            file_path = #{filePath},
            file_size = #{fileSize},
            download_url = #{downloadUrl},
            generated_by = #{generatedBy},
            tags_json = #{tagsJson},
            summary_json = #{summaryJson},
            trend_data_json = #{trendDataJson},
            report_config_id = #{reportConfigId},
            iso_metrics = #{isoMetrics},
            executive_summary = #{executiveSummary},
            conclusion_recommendation = #{conclusionRecommendation},
            risk_assessment = #{riskAssessment},
            defect_analysis = #{defectAnalysis},
            environment_details = #{environmentDetails},
            test_scope_details = #{testScopeDetails},
            updated_at = NOW()
        WHERE report_id = #{reportId}
        AND is_deleted = FALSE
    </update>

    <!-- 鏍规嵁鎶ュ憡ID鏌ヨ娴嬭瘯缁撴灉鍒楄〃 -->
    <select id="findTestCaseResultsByReportId" resultType="com.victor.iatms.entity.po.TestCaseResult">
        SELECT 
            result_id, report_id, execution_id, task_type, ref_id, full_name, status, duration,
            start_time, end_time, failure_message, failure_trace, failure_type, error_code,
            steps_json, parameters_json, attachments_json, logs_link, screenshot_link, video_link,
            environment, browser, os, device, tags_json, severity, priority, retry_count, flaky,
            case_id, case_code, case_name, module_name, api_name, suite_name, package_name,
            epic_name, feature_name, story_name, test_layer, test_type, flaky_count, last_flaky_time,
            history_trend, custom_labels, root_cause_analysis, impact_assessment, retest_result, retest_notes,
            created_at, is_deleted, deleted_at, deleted_by
        FROM TestCaseResults
        WHERE report_id = #{reportId}
        AND is_deleted = FALSE
        ORDER BY created_at DESC
    </select>

    <!-- 鏍规嵁鎵цID鏌ヨ娴嬭瘯缁撴灉 -->
    <select id="findTestCaseResultByExecutionId" resultType="com.victor.iatms.entity.po.TestCaseResult">
        SELECT 
            result_id, report_id, execution_id, task_type, ref_id, full_name, status, duration,
            start_time, end_time, failure_message, failure_trace, failure_type, error_code,
            steps_json, parameters_json, attachments_json, logs_link, screenshot_link, video_link,
            environment, browser, os, device, tags_json, severity, priority, retry_count, flaky,
            case_id, case_code, case_name, module_name, api_name, suite_name, package_name,
            epic_name, feature_name, story_name, test_layer, test_type, flaky_count, last_flaky_time,
            history_trend, custom_labels, root_cause_analysis, impact_assessment, retest_result, retest_notes,
            created_at, is_deleted, deleted_at, deleted_by
        FROM TestCaseResults
        WHERE execution_id = #{executionId}
        AND is_deleted = FALSE
        LIMIT 1
    </select>

    <!-- 鏍规嵁鎶ュ憡ID鏌ヨ鎶ュ憡姹囨€?-->
    <select id="findTestReportSummaryById" resultType="com.victor.iatms.entity.po.TestReportSummary">
        SELECT 
            report_id, report_name, report_type, execution_id, project_id, environment, start_time, end_time, duration,
            total_cases, executed_cases, passed_cases, failed_cases, broken_cases, skipped_cases, success_rate,
            total_duration, avg_duration, max_duration, min_duration, report_status, file_format, file_path,
            file_size, download_url, generated_by, tags_json, summary_json, trend_data_json,
            created_at, updated_at, is_deleted, deleted_at, deleted_by
        FROM TestReportSummaries
        WHERE report_id = #{reportId}
        AND is_deleted = FALSE
    </select>

    <!-- 鏌ヨ鏈€鏂扮殑鎶ュ憡姹囨€?-->
    <select id="findLatestReportSummary" resultType="com.victor.iatms.entity.po.TestReportSummary">
        SELECT 
            report_id, report_name, report_type, execution_id, project_id, environment, start_time, end_time, duration,
            total_cases, executed_cases, passed_cases, failed_cases, broken_cases, skipped_cases, success_rate,
            total_duration, avg_duration, max_duration, min_duration, report_status, file_format, file_path,
            file_size, download_url, generated_by, tags_json, summary_json, trend_data_json,
            created_at, updated_at, is_deleted, deleted_at, deleted_by
        FROM TestReportSummaries
        WHERE project_id = #{projectId}
        AND environment = #{environment}
        AND is_deleted = FALSE
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <!-- 鏇存柊娴嬭瘯缁撴灉 -->
    <update id="updateTestCaseResult" parameterType="com.victor.iatms.entity.po.TestCaseResult">
        UPDATE TestCaseResults SET
            report_id = #{reportId},
            task_type = #{taskType},
            ref_id = #{refId},
            full_name = #{fullName},
            status = #{status},
            duration = #{duration},
            start_time = #{startTime},
            end_time = #{endTime},
            failure_message = #{failureMessage},
            failure_trace = #{failureTrace},
            failure_type = #{failureType},
            error_code = #{errorCode},
            steps_json = #{stepsJson},
            parameters_json = #{parametersJson},
            attachments_json = #{attachmentsJson},
            logs_link = #{logsLink},
            screenshot_link = #{screenshotLink},
            video_link = #{videoLink},
            environment = #{environment},
            browser = #{browser},
            os = #{os},
            device = #{device},
            tags_json = #{tagsJson},
            severity = #{severity},
            priority = #{priority},
            retry_count = #{retryCount},
            flaky = #{flaky},
            case_id = #{caseId},
            case_code = #{caseCode},
            case_name = #{caseName},
            module_name = #{moduleName},
            api_name = #{apiName},
            suite_name = #{suiteName},
            package_name = #{packageName},
            epic_name = #{epicName},
            feature_name = #{featureName},
            story_name = #{storyName},
            test_layer = #{testLayer},
            test_type = #{testType},
            flaky_count = #{flakyCount},
            last_flaky_time = #{lastFlakyTime},
            history_trend = #{historyTrend},
            custom_labels = #{customLabels},
            root_cause_analysis = #{rootCauseAnalysis},
            impact_assessment = #{impactAssessment},
            retest_result = #{retestResult},
            retest_notes = #{retestNotes}
        WHERE execution_id = #{executionId}
        AND is_deleted = FALSE
    </update>

    <!-- ========== 妯″潡鎵ц鐩稿叧SQL ========== -->

    <!-- 鏍规嵁ID鏌ヨ妯″潡 -->
    <select id="findModuleById" resultType="com.victor.iatms.entity.po.Module">
        SELECT 
            module_id,
            module_code,
            project_id,
            name,
            description,
            status,
            version,
            created_by,
            updated_by,
            created_at,
            updated_at,
            is_deleted,
            deleted_at,
            deleted_by
        FROM Modules 
        WHERE module_id = #{moduleId} 
        AND is_deleted = FALSE
    </select>

    <!-- 鏌ヨ妯″潡涓嬬殑鎵€鏈夋帴鍙ｇ殑娴嬭瘯鐢ㄤ緥 -->
    <select id="findTestCasesByModuleId" resultType="com.victor.iatms.entity.po.TestCase">
        SELECT 
            tc.case_id,
            tc.case_code,
            tc.api_id,
            tc.name,
            tc.description,
            tc.priority,
            tc.severity,
            tc.tags,
            tc.pre_conditions,
            tc.test_steps,
            tc.request_override,
            tc.expected_http_status,
            tc.expected_response_schema,
            tc.expected_response_body,
            tc.assertions,
            tc.extractors,
            tc.validators,
            tc.is_enabled,
            tc.is_template,
            tc.template_id,
            tc.version,
            tc.created_by,
            tc.updated_by,
            tc.created_at,
            tc.updated_at,
            tc.is_deleted,
            tc.deleted_at,
            tc.deleted_by
        FROM TestCases tc
        INNER JOIN Apis a ON tc.api_id = a.api_id
        WHERE a.module_id = #{moduleId}
        AND tc.is_deleted = FALSE
        AND a.is_deleted = FALSE
        AND a.status = 'active'
        <if test="enabledOnly != null and enabledOnly == true">
            AND tc.is_enabled = TRUE
        </if>
        <if test="priorityList != null and priorityList.size() > 0">
            AND tc.priority IN
            <foreach collection="priorityList" item="priority" open="(" separator="," close=")">
                #{priority}
            </foreach>
        </if>
        <if test="tagsList != null and tagsList.size() > 0">
            AND EXISTS (
                SELECT 1 FROM JSON_TABLE(tc.tags, '$[*]' COLUMNS (tag VARCHAR(100) PATH '$')) jt
                WHERE jt.tag IN
                <foreach collection="tagsList" item="tag" open="(" separator="," close=")">
                    #{tag}
                </foreach>
            )
        </if>
        ORDER BY tc.priority, tc.created_at
    </select>

    <!-- 缁熻妯″潡涓嬬殑娴嬭瘯鐢ㄤ緥鏁伴噺 -->
    <select id="countTestCasesByModuleId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM TestCases tc
        INNER JOIN Apis a ON tc.api_id = a.api_id
        WHERE a.module_id = #{moduleId}
        AND tc.is_deleted = FALSE
        AND a.is_deleted = FALSE
        AND a.status = 'active'
        <if test="enabledOnly != null and enabledOnly == true">
            AND tc.is_enabled = TRUE
        </if>
        <if test="priorityList != null and priorityList.size() > 0">
            AND tc.priority IN
            <foreach collection="priorityList" item="priority" open="(" separator="," close=")">
                #{priority}
            </foreach>
        </if>
        <if test="tagsList != null and tagsList.size() > 0">
            AND EXISTS (
                SELECT 1 FROM JSON_TABLE(tc.tags, '$[*]' COLUMNS (tag VARCHAR(100) PATH '$')) jt
                WHERE jt.tag IN
                <foreach collection="tagsList" item="tag" open="(" separator="," close=")">
                    #{tag}
                </foreach>
            )
        </if>
    </select>

    <!-- 鏌ヨ妯″潡涓嬬殑鎺ュ彛鍒楄〃 -->
    <select id="findApiIdsByModuleId" resultType="java.lang.Integer">
        SELECT api_id
        FROM Apis
        WHERE module_id = #{moduleId}
        AND is_deleted = FALSE
        AND status = 'active'
        ORDER BY created_at
    </select>

    <!-- ========== 椤圭洰鎵ц鐩稿叧SQL ========== -->

    <!-- 鏍规嵁ID鏌ヨ椤圭洰 -->
    <select id="findProjectById" resultType="com.victor.iatms.entity.po.Project">
        SELECT 
            project_id,
            project_code,
            name,
            description,
            status,
            version,
            created_by,
            updated_by,
            created_at,
            updated_at,
            is_deleted,
            deleted_at,
            deleted_by
        FROM Projects 
        WHERE project_id = #{projectId} 
        AND is_deleted = FALSE
    </select>

    <!-- 鏌ヨ椤圭洰涓嬬殑鎵€鏈夋ā鍧?-->
    <select id="findModulesByProjectId" resultType="com.victor.iatms.entity.po.Module">
        SELECT 
            module_id,
            module_code,
            project_id,
            name,
            description,
            status,
            version,
            created_by,
            updated_by,
            created_at,
            updated_at,
            is_deleted,
            deleted_at,
            deleted_by
        FROM Modules 
        WHERE project_id = #{projectId}
        AND is_deleted = FALSE
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="moduleIds != null and moduleIds.size() > 0">
            AND module_id IN
            <foreach collection="moduleIds" item="moduleId" open="(" separator="," close=")">
                #{moduleId}
            </foreach>
        </if>
        ORDER BY created_at
    </select>

    <!-- 鏌ヨ椤圭洰涓嬬殑鎵€鏈夋祴璇曠敤渚?-->
    <select id="findTestCasesByProjectId" resultType="com.victor.iatms.entity.po.TestCase">
        SELECT 
            tc.case_id,
            tc.case_code,
            tc.api_id,
            tc.name,
            tc.description,
            tc.priority,
            tc.severity,
            tc.tags,
            tc.pre_conditions,
            tc.test_steps,
            tc.request_override,
            tc.expected_http_status,
            tc.expected_response_schema,
            tc.expected_response_body,
            tc.assertions,
            tc.extractors,
            tc.validators,
            tc.is_enabled,
            tc.is_template,
            tc.template_id,
            tc.version,
            tc.created_by,
            tc.updated_by,
            tc.created_at,
            tc.updated_at,
            tc.is_deleted,
            tc.deleted_at,
            tc.deleted_by
        FROM TestCases tc
        INNER JOIN Apis a ON tc.api_id = a.api_id
        INNER JOIN Modules m ON a.module_id = m.module_id
        WHERE m.project_id = #{projectId}
        AND tc.is_deleted = FALSE
        AND a.is_deleted = FALSE
        AND m.is_deleted = FALSE
        AND a.status = 'active'
        AND m.status = 'active'
        <if test="moduleIds != null and moduleIds.size() > 0">
            AND m.module_id IN
            <foreach collection="moduleIds" item="moduleId" open="(" separator="," close=")">
                #{moduleId}
            </foreach>
        </if>
        <if test="enabledOnly != null and enabledOnly == true">
            AND tc.is_enabled = TRUE
        </if>
        <if test="priorityList != null and priorityList.size() > 0">
            AND tc.priority IN
            <foreach collection="priorityList" item="priority" open="(" separator="," close=")">
                #{priority}
            </foreach>
        </if>
        <if test="tagsList != null and tagsList.size() > 0">
            AND EXISTS (
                SELECT 1 FROM JSON_TABLE(tc.tags, '$[*]' COLUMNS (tag VARCHAR(100) PATH '$')) jt
                WHERE jt.tag IN
                <foreach collection="tagsList" item="tag" open="(" separator="," close=")">
                    #{tag}
                </foreach>
            )
        </if>
        ORDER BY tc.priority, tc.created_at
    </select>

    <!-- 缁熻椤圭洰涓嬬殑娴嬭瘯鐢ㄤ緥鏁伴噺 -->
    <select id="countTestCasesByProjectId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM TestCases tc
        INNER JOIN Apis a ON tc.api_id = a.api_id
        INNER JOIN Modules m ON a.module_id = m.module_id
        WHERE m.project_id = #{projectId}
        AND tc.is_deleted = FALSE
        AND a.is_deleted = FALSE
        AND m.is_deleted = FALSE
        AND a.status = 'active'
        AND m.status = 'active'
        <if test="moduleIds != null and moduleIds.size() > 0">
            AND m.module_id IN
            <foreach collection="moduleIds" item="moduleId" open="(" separator="," close=")">
                #{moduleId}
            </foreach>
        </if>
        <if test="enabledOnly != null and enabledOnly == true">
            AND tc.is_enabled = TRUE
        </if>
        <if test="priorityList != null and priorityList.size() > 0">
            AND tc.priority IN
            <foreach collection="priorityList" item="priority" open="(" separator="," close=")">
                #{priority}
            </foreach>
        </if>
        <if test="tagsList != null and tagsList.size() > 0">
            AND EXISTS (
                SELECT 1 FROM JSON_TABLE(tc.tags, '$[*]' COLUMNS (tag VARCHAR(100) PATH '$')) jt
                WHERE jt.tag IN
                <foreach collection="tagsList" item="tag" open="(" separator="," close=")">
                    #{tag}
                </foreach>
            )
        </if>
    </select>

    <!-- 鏌ヨ椤圭洰涓嬬殑妯″潡ID鍒楄〃 -->
    <select id="findModuleIdsByProjectId" resultType="java.lang.Integer">
        SELECT module_id
        FROM Modules
        WHERE project_id = #{projectId}
        AND is_deleted = FALSE
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="moduleIds != null and moduleIds.size() > 0">
            AND module_id IN
            <foreach collection="moduleIds" item="moduleId" open="(" separator="," close=")">
                #{moduleId}
            </foreach>
        </if>
        ORDER BY created_at
    </select>

    <!-- ========== 鎺ュ彛鎵ц鐩稿叧SQL ========== -->

    <!-- 鏍规嵁ID鏌ヨ鎺ュ彛 -->
    <select id="findApiById" resultType="com.victor.iatms.entity.po.Api">
        SELECT 
            api_id,
            api_code,
            module_id,
            name,
            method,
            path,
            base_url,
            full_url,
            request_parameters,
            path_parameters,
            request_headers,
            request_body,
            request_body_type,
            response_body_type,
            description,
            status,
            version,
            timeout_seconds,
            auth_type,
            auth_config,
            tags,
            examples,
            created_by,
            updated_by,
            created_at,
            updated_at,
            is_deleted,
            deleted_at,
            deleted_by
        FROM Apis 
        WHERE api_id = #{apiId} 
        AND is_deleted = FALSE
    </select>

    <!-- 鏌ヨ鎺ュ彛涓嬬殑鎵€鏈夋祴璇曠敤渚?-->
    <select id="findTestCasesByApiId" resultType="com.victor.iatms.entity.po.TestCase">
        SELECT 
            tc.case_id,
            tc.case_code,
            tc.api_id,
            tc.name,
            tc.description,
            tc.priority,
            tc.severity,
            tc.tags,
            tc.pre_conditions,
            tc.test_steps,
            tc.request_override,
            tc.expected_http_status,
            tc.expected_response_schema,
            tc.expected_response_body,
            tc.assertions,
            tc.extractors,
            tc.validators,
            tc.is_enabled,
            tc.is_template,
            tc.template_id,
            tc.version,
            tc.created_by,
            tc.updated_by,
            tc.created_at,
            tc.updated_at,
            tc.is_deleted,
            tc.deleted_at,
            tc.deleted_by
        FROM TestCases tc
        WHERE tc.api_id = #{apiId}
        AND tc.is_deleted = FALSE
        <if test="enabledOnly != null and enabledOnly == true">
            AND tc.is_enabled = TRUE
        </if>
        <if test="priorityList != null and priorityList.size() > 0">
            AND tc.priority IN
            <foreach collection="priorityList" item="priority" open="(" separator="," close=")">
                #{priority}
            </foreach>
        </if>
        <if test="tagsList != null and tagsList.size() > 0">
            AND EXISTS (
                SELECT 1 FROM JSON_TABLE(tc.tags, '$[*]' COLUMNS (tag VARCHAR(100) PATH '$')) jt
                WHERE jt.tag IN
                <foreach collection="tagsList" item="tag" open="(" separator="," close=")">
                    #{tag}
                </foreach>
            )
        </if>
        <choose>
            <when test="executionOrder != null and executionOrder == 'priority_desc'">
                ORDER BY 
                    CASE tc.priority 
                        WHEN 'P0' THEN 1 
                        WHEN 'P1' THEN 2 
                        WHEN 'P2' THEN 3 
                        WHEN 'P3' THEN 4 
                        ELSE 5 
                    END ASC, tc.created_at DESC
            </when>
            <when test="executionOrder != null and executionOrder == 'priority_asc'">
                ORDER BY 
                    CASE tc.priority 
                        WHEN 'P0' THEN 1 
                        WHEN 'P1' THEN 2 
                        WHEN 'P2' THEN 3 
                        WHEN 'P3' THEN 4 
                        ELSE 5 
                    END DESC, tc.created_at ASC
            </when>
            <when test="executionOrder != null and executionOrder == 'name_asc'">
                ORDER BY tc.name ASC, tc.created_at ASC
            </when>
            <when test="executionOrder != null and executionOrder == 'name_desc'">
                ORDER BY tc.name DESC, tc.created_at DESC
            </when>
            <otherwise>
                ORDER BY 
                    CASE tc.priority 
                        WHEN 'P0' THEN 1 
                        WHEN 'P1' THEN 2 
                        WHEN 'P2' THEN 3 
                        WHEN 'P3' THEN 4 
                        ELSE 5 
                    END ASC, tc.created_at DESC
            </otherwise>
        </choose>
    </select>

    <!-- 缁熻鎺ュ彛涓嬬殑娴嬭瘯鐢ㄤ緥鏁伴噺 -->
    <select id="countTestCasesByApiId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM TestCases tc
        WHERE tc.api_id = #{apiId}
        AND tc.is_deleted = FALSE
        <if test="enabledOnly != null and enabledOnly == true">
            AND tc.is_enabled = TRUE
        </if>
        <if test="priorityList != null and priorityList.size() > 0">
            AND tc.priority IN
            <foreach collection="priorityList" item="priority" open="(" separator="," close=")">
                #{priority}
            </foreach>
        </if>
        <if test="tagsList != null and tagsList.size() > 0">
            AND EXISTS (
                SELECT 1 FROM JSON_TABLE(tc.tags, '$[*]' COLUMNS (tag VARCHAR(100) PATH '$')) jt
                WHERE jt.tag IN
                <foreach collection="tagsList" item="tag" open="(" separator="," close=")">
                    #{tag}
                </foreach>
            )
        </if>
    </select>

    <!-- ========== 娴嬭瘯濂椾欢鎵ц鐩稿叧SQL ========== -->

    <!-- 鏍规嵁ID鏌ヨ娴嬭瘯濂椾欢 -->
    <select id="findTestSuiteById" resultType="com.victor.iatms.entity.po.TestSuite">
        SELECT 
            suite_id,
            suite_code,
            name,
            description,
            status,
            project_id,
            created_by,
            updated_by,
            created_at,
            updated_at,
            is_deleted,
            deleted_at,
            deleted_by
        FROM TestSuites 
        WHERE suite_id = #{suiteId} 
        AND is_deleted = FALSE
    </select>

    <!-- 鏌ヨ娴嬭瘯濂椾欢涓嬬殑鎵€鏈夋祴璇曠敤渚?-->
    <select id="findTestCasesBySuiteId" resultType="com.victor.iatms.entity.po.TestCase">
        SELECT 
            tc.case_id,
            tc.case_code,
            tc.api_id,
            tc.name,
            tc.description,
            tc.priority,
            tc.severity,
            tc.tags,
            tc.pre_conditions,
            tc.test_steps,
            tc.request_override,
            tc.expected_http_status,
            tc.expected_response_schema,
            tc.expected_response_body,
            tc.assertions,
            tc.extractors,
            tc.validators,
            tc.is_enabled,
            tc.is_template,
            tc.template_id,
            tc.version,
            tc.created_by,
            tc.updated_by,
            tc.created_at,
            tc.updated_at,
            tc.is_deleted,
            tc.deleted_at,
            tc.deleted_by
        FROM TestCases tc
        INNER JOIN SuiteCaseMappings scm ON tc.case_id = scm.case_id
        WHERE scm.suite_id = #{suiteId}
        AND tc.is_deleted = FALSE
        AND scm.is_deleted = FALSE
        <if test="enabledOnly != null and enabledOnly == true">
            AND tc.is_enabled = TRUE
        </if>
        <if test="priorityList != null and priorityList.size() > 0">
            AND tc.priority IN
            <foreach collection="priorityList" item="priority" open="(" separator="," close=")">
                #{priority}
            </foreach>
        </if>
        <if test="tagsList != null and tagsList.size() > 0">
            AND EXISTS (
                SELECT 1 FROM JSON_TABLE(tc.tags, '$[*]' COLUMNS (tag VARCHAR(100) PATH '$')) jt
                WHERE jt.tag IN
                <foreach collection="tagsList" item="tag" open="(" separator="," close=")">
                    #{tag}
                </foreach>
            )
        </if>
        ORDER BY 
            CASE tc.priority 
                WHEN 'P0' THEN 1 
                WHEN 'P1' THEN 2 
                WHEN 'P2' THEN 3 
                WHEN 'P3' THEN 4 
                ELSE 5 
            END ASC, tc.created_at DESC
    </select>

    <!-- 缁熻娴嬭瘯濂椾欢涓嬬殑娴嬭瘯鐢ㄤ緥鏁伴噺 -->
    <select id="countTestCasesBySuiteId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM TestCases tc
        INNER JOIN SuiteCaseMappings scm ON tc.case_id = scm.case_id
        WHERE scm.suite_id = #{suiteId}
        AND tc.is_deleted = FALSE
        AND scm.is_deleted = FALSE
        <if test="enabledOnly != null and enabledOnly == true">
            AND tc.is_enabled = TRUE
        </if>
        <if test="priorityList != null and priorityList.size() > 0">
            AND tc.priority IN
            <foreach collection="priorityList" item="priority" open="(" separator="," close=")">
                #{priority}
            </foreach>
        </if>
        <if test="tagsList != null and tagsList.size() > 0">
            AND EXISTS (
                SELECT 1 FROM JSON_TABLE(tc.tags, '$[*]' COLUMNS (tag VARCHAR(100) PATH '$')) jt
                WHERE jt.tag IN
                <foreach collection="tagsList" item="tag" open="(" separator="," close=")">
                    #{tag}
                </foreach>
            )
        </if>
    </select>

    <!-- ========== 娴嬭瘯缁撴灉鏌ヨ鐩稿叧SQL ========== -->

    <!-- 鍒嗛〉鏌ヨ娴嬭瘯缁撴灉鍒楄〃 -->
    <select id="findTestResults" resultType="com.victor.iatms.entity.po.TestCaseResult">
        SELECT 
            tcr.result_id,
            tcr.report_id,
            tcr.execution_id,
            tcr.task_type,
            tcr.ref_id,
            tcr.full_name,
            tcr.status,
            tcr.duration,
            tcr.start_time,
            tcr.end_time,
            tcr.failure_message,
            tcr.failure_trace,
            tcr.failure_type,
            tcr.error_code,
            tcr.steps_json,
            tcr.parameters_json,
            tcr.attachments_json,
            tcr.logs_link,
            tcr.screenshot_link,
            tcr.video_link,
            tcr.environment,
            tcr.browser,
            tcr.os,
            tcr.device,
            tcr.tags_json,
            tcr.severity,
            tcr.priority,
            tcr.retry_count,
            tcr.flaky,
            tcr.case_id,
            tcr.case_code,
            tcr.case_name,
            tcr.module_name,
            tcr.api_name,
            tcr.suite_name,
            tcr.package_name,
            tcr.epic_name,
            tcr.feature_name,
            tcr.story_name,
            tcr.test_layer,
            tcr.test_type,
            tcr.flaky_count,
            tcr.last_flaky_time,
            tcr.history_trend,
            tcr.custom_labels,
            tcr.root_cause_analysis,
            tcr.impact_assessment,
            tcr.retest_result,
            tcr.retest_notes,
            tcr.created_at
        FROM TestCaseResults tcr
        WHERE tcr.is_deleted = FALSE
        <if test="query.taskType != null and query.taskType != ''">
            AND tcr.task_type = #{query.taskType}
        </if>
        <if test="query.refId != null">
            AND tcr.ref_id = #{query.refId}
        </if>
        <if test="query.status != null and query.status != ''">
            AND tcr.status = #{query.status}
        </if>
        <if test="query.environment != null and query.environment != ''">
            AND tcr.environment = #{query.environment}
        </if>
        <if test="query.priority != null and query.priority != ''">
            AND tcr.priority IN
            <foreach collection="query.priority.split(',')" item="p" open="(" separator="," close=")">
                #{p}
            </foreach>
        </if>
        <if test="query.severity != null and query.severity != ''">
            AND tcr.severity = #{query.severity}
        </if>
        <if test="query.startTimeBegin != null">
            AND tcr.start_time &gt;= #{query.startTimeBegin}
        </if>
        <if test="query.startTimeEnd != null">
            AND tcr.start_time &lt;= #{query.startTimeEnd}
        </if>
        <if test="query.durationMin != null">
            AND tcr.duration &gt;= #{query.durationMin}
        </if>
        <if test="query.durationMax != null">
            AND tcr.duration &lt;= #{query.durationMax}
        </if>
        <if test="query.searchKeyword != null and query.searchKeyword != ''">
            AND (
                tcr.full_name LIKE CONCAT('%', #{query.searchKeyword}, '%')
                OR tcr.failure_message LIKE CONCAT('%', #{query.searchKeyword}, '%')
            )
        </if>
        <choose>
            <when test="query.sortBy == 'start_time'">
                ORDER BY tcr.start_time
                <if test="query.sortOrder == 'asc'">ASC</if>
                <if test="query.sortOrder != 'asc'">DESC</if>
            </when>
            <when test="query.sortBy == 'duration'">
                ORDER BY tcr.duration
                <if test="query.sortOrder == 'asc'">ASC</if>
                <if test="query.sortOrder != 'asc'">DESC</if>
            </when>
            <when test="query.sortBy == 'priority'">
                ORDER BY 
                    CASE tcr.priority 
                        WHEN 'P0' THEN 1 
                        WHEN 'P1' THEN 2 
                        WHEN 'P2' THEN 3 
                        WHEN 'P3' THEN 4 
                        ELSE 5 
                    END
                <if test="query.sortOrder == 'asc'">ASC</if>
                <if test="query.sortOrder != 'asc'">DESC</if>
            </when>
            <when test="query.sortBy == 'severity'">
                ORDER BY 
                    CASE tcr.severity 
                        WHEN 'blocker' THEN 1 
                        WHEN 'critical' THEN 2 
                        WHEN 'normal' THEN 3 
                        WHEN 'minor' THEN 4 
                        WHEN 'trivial' THEN 5
                        ELSE 6 
                    END
                <if test="query.sortOrder == 'asc'">ASC</if>
                <if test="query.sortOrder != 'asc'">DESC</if>
            </when>
            <otherwise>
                ORDER BY tcr.start_time DESC
            </otherwise>
        </choose>
        LIMIT #{query.offset}, #{query.pageSize}
    </select>

    <!-- 缁熻娴嬭瘯缁撴灉鎬绘暟 -->
    <select id="countTestResults" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM TestCaseResults tcr
        WHERE tcr.is_deleted = FALSE
        <if test="query.taskType != null and query.taskType != ''">
            AND tcr.task_type = #{query.taskType}
        </if>
        <if test="query.refId != null">
            AND tcr.ref_id = #{query.refId}
        </if>
        <if test="query.status != null and query.status != ''">
            AND tcr.status = #{query.status}
        </if>
        <if test="query.environment != null and query.environment != ''">
            AND tcr.environment = #{query.environment}
        </if>
        <if test="query.priority != null and query.priority != ''">
            AND tcr.priority IN
            <foreach collection="query.priority.split(',')" item="p" open="(" separator="," close=")">
                #{p}
            </foreach>
        </if>
        <if test="query.severity != null and query.severity != ''">
            AND tcr.severity = #{query.severity}
        </if>
        <if test="query.startTimeBegin != null">
            AND tcr.start_time &gt;= #{query.startTimeBegin}
        </if>
        <if test="query.startTimeEnd != null">
            AND tcr.start_time &lt;= #{query.startTimeEnd}
        </if>
        <if test="query.durationMin != null">
            AND tcr.duration &gt;= #{query.durationMin}
        </if>
        <if test="query.durationMax != null">
            AND tcr.duration &lt;= #{query.durationMax}
        </if>
        <if test="query.searchKeyword != null and query.searchKeyword != ''">
            AND (
                tcr.full_name LIKE CONCAT('%', #{query.searchKeyword}, '%')
                OR tcr.failure_message LIKE CONCAT('%', #{query.searchKeyword}, '%')
            )
        </if>
    </select>

    <!-- 缁熻娴嬭瘯缁撴灉鎽樿 -->
    <select id="getTestResultSummary" resultType="com.victor.iatms.entity.dto.TestResultSummaryDTO">
        SELECT 
            COUNT(*) as totalCount,
            SUM(CASE WHEN tcr.status = 'passed' THEN 1 ELSE 0 END) as passed,
            SUM(CASE WHEN tcr.status = 'failed' THEN 1 ELSE 0 END) as failed,
            SUM(CASE WHEN tcr.status = 'broken' THEN 1 ELSE 0 END) as broken,
            SUM(CASE WHEN tcr.status = 'skipped' THEN 1 ELSE 0 END) as skipped,
            SUM(CASE WHEN tcr.status = 'unknown' THEN 1 ELSE 0 END) as unknown,
            ROUND(
                (SUM(CASE WHEN tcr.status = 'passed' THEN 1 ELSE 0 END) * 100.0) / 
                NULLIF(COUNT(*), 0), 2
            ) as successRate,
            ROUND(AVG(tcr.duration), 0) as avgDuration
        FROM TestCaseResults tcr
        WHERE tcr.is_deleted = FALSE
        <if test="query.taskType != null and query.taskType != ''">
            AND tcr.task_type = #{query.taskType}
        </if>
        <if test="query.refId != null">
            AND tcr.ref_id = #{query.refId}
        </if>
        <if test="query.status != null and query.status != ''">
            AND tcr.status = #{query.status}
        </if>
        <if test="query.environment != null and query.environment != ''">
            AND tcr.environment = #{query.environment}
        </if>
        <if test="query.priority != null and query.priority != ''">
            AND tcr.priority IN
            <foreach collection="query.priority.split(',')" item="p" open="(" separator="," close=")">
                #{p}
            </foreach>
        </if>
        <if test="query.severity != null and query.severity != ''">
            AND tcr.severity = #{query.severity}
        </if>
        <if test="query.startTimeBegin != null">
            AND tcr.start_time &gt;= #{query.startTimeBegin}
        </if>
        <if test="query.startTimeEnd != null">
            AND tcr.start_time &lt;= #{query.startTimeEnd}
        </if>
        <if test="query.durationMin != null">
            AND tcr.duration &gt;= #{query.durationMin}
        </if>
        <if test="query.durationMax != null">
            AND tcr.duration &lt;= #{query.durationMax}
        </if>
        <if test="query.searchKeyword != null and query.searchKeyword != ''">
            AND (
                tcr.full_name LIKE CONCAT('%', #{query.searchKeyword}, '%')
                OR tcr.failure_message LIKE CONCAT('%', #{query.searchKeyword}, '%')
            )
        </if>
    </select>

    <!-- 鏍规嵁缁撴灉ID鏌ヨ娴嬭瘯缁撴灉璇︽儏 -->
    <select id="findTestResultById" resultType="com.victor.iatms.entity.po.TestCaseResult">
        SELECT 
            result_id,
            report_id,
            execution_id,
            task_type,
            ref_id,
            full_name,
            status,
            duration,
            start_time,
            end_time,
            failure_message,
            failure_trace,
            failure_type,
            error_code,
            steps_json,
            parameters_json,
            attachments_json,
            logs_link,
            screenshot_link,
            video_link,
            environment,
            browser,
            os,
            device,
            tags_json,
            severity,
            priority,
            retry_count,
            flaky,
            case_id,
            case_code,
            case_name,
            module_name,
            api_name,
            suite_name,
            package_name,
            epic_name,
            feature_name,
            story_name,
            test_layer,
            test_type,
            flaky_count,
            last_flaky_time,
            history_trend,
            custom_labels,
            root_cause_analysis,
            impact_assessment,
            retest_result,
            retest_notes,
            created_at,
            is_deleted,
            deleted_at,
            deleted_by
        FROM TestCaseResults
        WHERE result_id = #{resultId}
        AND is_deleted = FALSE
    </select>

    <!-- ========== 娴嬭瘯缁熻鐩稿叧SQL ========== -->

    <!-- 鑾峰彇缁熻鎽樿 -->
    <select id="getStatisticsSummary" resultType="com.victor.iatms.entity.dto.StatisticsSummaryDTO">
        SELECT 
            COUNT(*) as totalExecutions,
            COUNT(DISTINCT ref_id) as totalCases,
            SUM(CASE WHEN status = 'passed' THEN 1 ELSE 0 END) as passed,
            SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed,
            SUM(CASE WHEN status = 'broken' THEN 1 ELSE 0 END) as broken,
            SUM(CASE WHEN status = 'skipped' THEN 1 ELSE 0 END) as skipped,
            ROUND((SUM(CASE WHEN status = 'passed' THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0), 2) as successRate,
            ROUND(AVG(duration), 0) as avgDuration,
            MAX(duration) as maxDuration,
            MIN(duration) as minDuration
        FROM TestCaseResults
        WHERE is_deleted = FALSE
        <if test="startTime != null">
            AND start_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND start_time &lt;= #{endTime}
        </if>
        <if test="projectId != null">
            AND EXISTS (
                SELECT 1 FROM TestReportSummaries trs 
                WHERE trs.report_id = TestCaseResults.report_id 
                AND trs.project_id = #{projectId}
            )
        </if>
        <if test="environment != null and environment != ''">
            AND environment = #{environment}
        </if>
    </select>

    <!-- 鎸夋椂闂村垎缁勮幏鍙栬秼鍔挎暟鎹?-->
    <select id="getTrendData" resultType="com.victor.iatms.entity.dto.TrendDataDTO">
        SELECT 
            <choose>
                <when test="groupBy == 'hour'">
                    DATE_FORMAT(start_time, '%Y-%m-%d %H:00:00') as timePeriod,
                    DATE_FORMAT(start_time, '%m-%d %H:00') as label,
                </when>
                <when test="groupBy == 'day'">
                    DATE(start_time) as timePeriod,
                    DATE_FORMAT(start_time, '%m-%d') as label,
                </when>
                <when test="groupBy == 'week'">
                    DATE_FORMAT(start_time, '%Y-%u') as timePeriod,
                    CONCAT('W', WEEK(start_time)) as label,
                </when>
                <when test="groupBy == 'month'">
                    DATE_FORMAT(start_time, '%Y-%m') as timePeriod,
                    DATE_FORMAT(start_time, '%Y-%m') as label,
                </when>
                <otherwise>
                    DATE(start_time) as timePeriod,
                    DATE_FORMAT(start_time, '%m-%d') as label,
                </otherwise>
            </choose>
            COUNT(*) as total,
            SUM(CASE WHEN status = 'passed' THEN 1 ELSE 0 END) as passed,
            SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed,
            SUM(CASE WHEN status = 'broken' THEN 1 ELSE 0 END) as broken,
            SUM(CASE WHEN status = 'skipped' THEN 1 ELSE 0 END) as skipped,
            ROUND((SUM(CASE WHEN status = 'passed' THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0), 2) as successRate,
            ROUND(AVG(duration), 0) as avgDuration
        FROM TestCaseResults
        WHERE is_deleted = FALSE
        <if test="startTime != null">
            AND start_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND start_time &lt;= #{endTime}
        </if>
        <if test="projectId != null">
            AND EXISTS (
                SELECT 1 FROM TestReportSummaries trs 
                WHERE trs.report_id = TestCaseResults.report_id 
                AND trs.project_id = #{projectId}
            )
        </if>
        <if test="environment != null and environment != ''">
            AND environment = #{environment}
        </if>
        GROUP BY timePeriod, label
        ORDER BY timePeriod ASC
    </select>

    <!-- 鎸夋寚瀹氱淮搴﹀垎缁勮幏鍙栫粺璁℃暟鎹?-->
    <select id="getGroupData" resultType="com.victor.iatms.entity.dto.GroupDataDTO">
        SELECT 
            <choose>
                <when test="groupBy == 'priority'">
                    priority as groupKey,
                    CONCAT(priority, '-', 
                        CASE priority 
                            WHEN 'P0' THEN '鏈€楂樹紭鍏堢骇'
                            WHEN 'P1' THEN '楂樹紭鍏堢骇'
                            WHEN 'P2' THEN '涓紭鍏堢骇'
                            WHEN 'P3' THEN '浣庝紭鍏堢骇'
                            ELSE '鏈煡'
                        END
                    ) as groupName,
                </when>
                <when test="groupBy == 'severity'">
                    severity as groupKey,
                    CONCAT(severity, '-', 
                        CASE severity 
                            WHEN 'blocker' THEN '闃诲'
                            WHEN 'critical' THEN '涓ラ噸'
                            WHEN 'normal' THEN '涓€鑸?
                            WHEN 'minor' THEN '娆¤'
                            WHEN 'trivial' THEN '杞诲井'
                            ELSE '鏈煡'
                        END
                    ) as groupName,
                </when>
                <otherwise>
                    task_type as groupKey,
                    task_type as groupName,
                </otherwise>
            </choose>
            COUNT(*) as total,
            SUM(CASE WHEN status = 'passed' THEN 1 ELSE 0 END) as passed,
            SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed,
            SUM(CASE WHEN status = 'broken' THEN 1 ELSE 0 END) as broken,
            SUM(CASE WHEN status = 'skipped' THEN 1 ELSE 0 END) as skipped,
            ROUND((SUM(CASE WHEN status = 'passed' THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0), 2) as successRate,
            ROUND(AVG(duration), 0) as avgDuration
        FROM TestCaseResults
        WHERE is_deleted = FALSE
        <if test="startTime != null">
            AND start_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND start_time &lt;= #{endTime}
        </if>
        <if test="projectId != null">
            AND EXISTS (
                SELECT 1 FROM TestReportSummaries trs 
                WHERE trs.report_id = TestCaseResults.report_id 
                AND trs.project_id = #{projectId}
            )
        </if>
        <if test="environment != null and environment != ''">
            AND environment = #{environment}
        </if>
        GROUP BY groupKey, groupName
        ORDER BY 
            <choose>
                <when test="groupBy == 'priority'">
                    CASE groupKey WHEN 'P0' THEN 1 WHEN 'P1' THEN 2 WHEN 'P2' THEN 3 WHEN 'P3' THEN 4 ELSE 5 END
                </when>
                <when test="groupBy == 'severity'">
                    CASE groupKey WHEN 'blocker' THEN 1 WHEN 'critical' THEN 2 WHEN 'normal' THEN 3 WHEN 'minor' THEN 4 WHEN 'trivial' THEN 5 ELSE 6 END
                </when>
                <otherwise>
                    total DESC
                </otherwise>
            </choose>
    </select>

    <!-- 鑾峰彇涓昏闂缁熻 -->
    <select id="getTopIssues" resultType="com.victor.iatms.entity.dto.TopIssueDTO">
        SELECT 
            failure_type as failureType,
            COUNT(*) as count,
            ROUND((COUNT(*) * 100.0) / (
                SELECT COUNT(*) FROM TestCaseResults 
                WHERE is_deleted = FALSE 
                AND status IN ('failed', 'broken')
                <if test="startTime != null">AND start_time &gt;= #{startTime}</if>
                <if test="endTime != null">AND start_time &lt;= #{endTime}</if>
                <if test="environment != null and environment != ''">AND environment = #{environment}</if>
            ), 2) as percentage,
            ROUND(AVG(duration), 0) as avgDuration
        FROM TestCaseResults
        WHERE is_deleted = FALSE
        AND status IN ('failed', 'broken')
        AND failure_type IS NOT NULL
        <if test="startTime != null">
            AND start_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND start_time &lt;= #{endTime}
        </if>
        <if test="projectId != null">
            AND EXISTS (
                SELECT 1 FROM TestReportSummaries trs 
                WHERE trs.report_id = TestCaseResults.report_id 
                AND trs.project_id = #{projectId}
            )
        </if>
        <if test="environment != null and environment != ''">
            AND environment = #{environment}
        </if>
        GROUP BY failure_type
        ORDER BY count DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- ========== 杩戜竷澶╂墽琛屾儏鍐电浉鍏砈QL ========== -->

    <!-- 鑾峰彇杩戜竷澶╂€讳綋缁熻鎽樿 -->
    <select id="getWeeklySummary" resultType="com.victor.iatms.entity.dto.SummaryDTO">
        SELECT 
            COUNT(*) as totalExecutions,
            COUNT(DISTINCT ref_id) as totalCases,
            SUM(CASE WHEN status = 'passed' THEN 1 ELSE 0 END) as passed,
            SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed,
            SUM(CASE WHEN status = 'broken' THEN 1 ELSE 0 END) as broken,
            SUM(CASE WHEN status = 'skipped' THEN 1 ELSE 0 END) as skipped,
            ROUND((SUM(CASE WHEN status = 'passed' THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0), 2) as successRate,
            ROUND(AVG(duration), 0) as avgDuration
        FROM TestCaseResults
        WHERE is_deleted = FALSE
        <if test="startTime != null">
            AND start_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND start_time &lt;= #{endTime}
        </if>
        <if test="projectId != null">
            AND EXISTS (
                SELECT 1 FROM TestReportSummaries trs 
                WHERE trs.report_id = TestCaseResults.report_id 
                AND trs.project_id = #{projectId}
            )
        </if>
        <if test="moduleId != null">
            AND EXISTS (
                SELECT 1 FROM TestReportSummaries trs 
                JOIN Modules m ON m.project_id = trs.project_id
                WHERE trs.report_id = TestCaseResults.report_id 
                AND m.module_id = #{moduleId}
            )
        </if>
        <if test="environment != null and environment != ''">
            AND environment = #{environment}
        </if>
    </select>

    <!-- 鑾峰彇杩戜竷澶╂瘡鏃ヨ秼鍔挎暟鎹?-->
    <select id="getWeeklyDailyTrend" resultType="com.victor.iatms.entity.dto.DailyTrendDTO">
        SELECT 
            DATE(start_time) as date,
            CASE DAYOFWEEK(start_time)
                WHEN 1 THEN '鍛ㄦ棩'
                WHEN 2 THEN '鍛ㄤ竴'
                WHEN 3 THEN '鍛ㄤ簩'
                WHEN 4 THEN '鍛ㄤ笁'
                WHEN 5 THEN '鍛ㄥ洓'
                WHEN 6 THEN '鍛ㄤ簲'
                WHEN 7 THEN '鍛ㄥ叚'
            END as dayOfWeek,
            COUNT(*) as total,
            SUM(CASE WHEN status = 'passed' THEN 1 ELSE 0 END) as passed,
            SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed,
            SUM(CASE WHEN status = 'broken' THEN 1 ELSE 0 END) as broken,
            SUM(CASE WHEN status = 'skipped' THEN 1 ELSE 0 END) as skipped,
            ROUND((SUM(CASE WHEN status = 'passed' THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0), 2) as successRate,
            ROUND(AVG(duration), 0) as avgDuration
        FROM TestCaseResults
        WHERE is_deleted = FALSE
        <if test="startTime != null">
            AND start_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND start_time &lt;= #{endTime}
        </if>
        <if test="projectId != null">
            AND EXISTS (
                SELECT 1 FROM TestReportSummaries trs 
                WHERE trs.report_id = TestCaseResults.report_id 
                AND trs.project_id = #{projectId}
            )
        </if>
        <if test="moduleId != null">
            AND EXISTS (
                SELECT 1 FROM TestReportSummaries trs 
                JOIN Modules m ON m.project_id = trs.project_id
                WHERE trs.report_id = TestCaseResults.report_id 
                AND m.module_id = #{moduleId}
            )
        </if>
        <if test="environment != null and environment != ''">
            AND environment = #{environment}
        </if>
        GROUP BY DATE(start_time), dayOfWeek
        ORDER BY date ASC
    </select>

    <!-- 鑾峰彇椤圭洰缁熻鎺掕锛堝墠5锛?-->
    <select id="getWeeklyProjectStats" resultType="com.victor.iatms.entity.dto.ProjectStatsDTO">
        SELECT 
            trs.project_id as projectId,
            p.project_name as projectName,
            COUNT(*) as executions,
            ROUND((SUM(CASE WHEN tcr.status = 'passed' THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0), 2) as successRate,
            ROUND(AVG(tcr.duration), 0) as avgDuration
        FROM TestCaseResults tcr
        JOIN TestReportSummaries trs ON trs.report_id = tcr.report_id
        JOIN Projects p ON p.project_id = trs.project_id
        WHERE tcr.is_deleted = FALSE
        <if test="startTime != null">
            AND tcr.start_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND tcr.start_time &lt;= #{endTime}
        </if>
        <if test="projectId != null">
            AND trs.project_id = #{projectId}
        </if>
        <if test="environment != null and environment != ''">
            AND tcr.environment = #{environment}
        </if>
        GROUP BY trs.project_id, p.project_name
        ORDER BY executions DESC
        LIMIT 5
    </select>

    <!-- 鑾峰彇妯″潡缁熻鎺掕锛堝墠5锛?-->
    <select id="getWeeklyModuleStats" resultType="com.victor.iatms.entity.dto.ModuleStatsDTO">
        SELECT 
            m.module_id as moduleId,
            m.module_name as moduleName,
            COUNT(*) as executions,
            ROUND((SUM(CASE WHEN tcr.status = 'passed' THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0), 2) as successRate,
            ROUND(AVG(tcr.duration), 0) as avgDuration
        FROM TestCaseResults tcr
        JOIN TestReportSummaries trs ON trs.report_id = tcr.report_id
        JOIN Modules m ON m.project_id = trs.project_id
        WHERE tcr.is_deleted = FALSE
        <if test="startTime != null">
            AND tcr.start_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND tcr.start_time &lt;= #{endTime}
        </if>
        <if test="projectId != null">
            AND trs.project_id = #{projectId}
        </if>
        <if test="moduleId != null">
            AND m.module_id = #{moduleId}
        </if>
        <if test="environment != null and environment != ''">
            AND tcr.environment = #{environment}
        </if>
        GROUP BY m.module_id, m.module_name
        ORDER BY executions DESC
        LIMIT 5
    </select>

    <!-- 鑾峰彇杩戜竷澶╀富瑕佸け璐ュ師鍥?-->
    <select id="getWeeklyTopFailures" resultType="com.victor.iatms.entity.dto.TopFailureDTO">
        SELECT 
            failure_type as failureType,
            COUNT(*) as count,
            ROUND((COUNT(*) * 100.0) / (
                SELECT COUNT(*) FROM TestCaseResults 
                WHERE is_deleted = FALSE 
                AND status IN ('failed', 'broken')
                <if test="startTime != null">AND start_time &gt;= #{startTime}</if>
                <if test="endTime != null">AND start_time &lt;= #{endTime}</if>
                <if test="environment != null and environment != ''">AND environment = #{environment}</if>
            ), 2) as percentage,
            ROUND(AVG(duration), 0) as avgDuration,
            'stable' as trend
        FROM TestCaseResults
        WHERE is_deleted = FALSE
        AND status IN ('failed', 'broken')
        AND failure_type IS NOT NULL
        <if test="startTime != null">
            AND start_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND start_time &lt;= #{endTime}
        </if>
        <if test="projectId != null">
            AND EXISTS (
                SELECT 1 FROM TestReportSummaries trs 
                WHERE trs.report_id = TestCaseResults.report_id 
                AND trs.project_id = #{projectId}
            )
        </if>
        <if test="moduleId != null">
            AND EXISTS (
                SELECT 1 FROM TestReportSummaries trs 
                JOIN Modules m ON m.project_id = trs.project_id
                WHERE trs.report_id = TestCaseResults.report_id 
                AND m.module_id = #{moduleId}
            )
        </if>
        <if test="environment != null and environment != ''">
            AND environment = #{environment}
        </if>
        GROUP BY failure_type
        ORDER BY count DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 鑾峰彇杩戜竷澶╂€ц兘鎸囨爣 -->
    <select id="getWeeklyPerformanceMetrics" resultType="com.victor.iatms.entity.dto.PerformanceMetricsDTO">
        SELECT 
            (SELECT duration FROM TestCaseResults 
             WHERE is_deleted = FALSE
             <if test="startTime != null">AND start_time &gt;= #{startTime}</if>
             <if test="endTime != null">AND start_time &lt;= #{endTime}</if>
             <if test="projectId != null">
                 AND EXISTS (SELECT 1 FROM TestReportSummaries trs 
                           WHERE trs.report_id = TestCaseResults.report_id 
                           AND trs.project_id = #{projectId})
             </if>
             <if test="moduleId != null">
                 AND EXISTS (SELECT 1 FROM TestReportSummaries trs 
                           JOIN Modules m ON m.project_id = trs.project_id
                           WHERE trs.report_id = TestCaseResults.report_id 
                           AND m.module_id = #{moduleId})
             </if>
             <if test="environment != null and environment != ''">AND environment = #{environment}</if>
             ORDER BY duration DESC LIMIT 1 OFFSET (SELECT FLOOR(COUNT(*) * 0.05) FROM TestCaseResults 
             WHERE is_deleted = FALSE
             <if test="startTime != null">AND start_time &gt;= #{startTime}</if>
             <if test="endTime != null">AND start_time &lt;= #{endTime}</if>
             <if test="environment != null and environment != ''">AND environment = #{environment}</if>
             )) as p95Duration,
            (SELECT duration FROM TestCaseResults 
             WHERE is_deleted = FALSE
             <if test="startTime != null">AND start_time &gt;= #{startTime}</if>
             <if test="endTime != null">AND start_time &lt;= #{endTime}</if>
             <if test="projectId != null">
                 AND EXISTS (SELECT 1 FROM TestReportSummaries trs 
                           WHERE trs.report_id = TestCaseResults.report_id 
                           AND trs.project_id = #{projectId})
             </if>
             <if test="moduleId != null">
                 AND EXISTS (SELECT 1 FROM TestReportSummaries trs 
                           JOIN Modules m ON m.project_id = trs.project_id
                           WHERE trs.report_id = TestCaseResults.report_id 
                           AND m.module_id = #{moduleId})
             </if>
             <if test="environment != null and environment != ''">AND environment = #{environment}</if>
             ORDER BY duration DESC LIMIT 1 OFFSET (SELECT FLOOR(COUNT(*) * 0.01) FROM TestCaseResults 
             WHERE is_deleted = FALSE
             <if test="startTime != null">AND start_time &gt;= #{startTime}</if>
             <if test="endTime != null">AND start_time &lt;= #{endTime}</if>
             <if test="environment != null and environment != ''">AND environment = #{environment}</if>
             )) as p99Duration,
            MAX(duration) as maxDuration,
            MIN(duration) as minDuration,
            ROUND(COUNT(*) / 7.0, 2) as throughput
        FROM TestCaseResults
        WHERE is_deleted = FALSE
        <if test="startTime != null">
            AND start_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND start_time &lt;= #{endTime}
        </if>
        <if test="projectId != null">
            AND EXISTS (
                SELECT 1 FROM TestReportSummaries trs 
                WHERE trs.report_id = TestCaseResults.report_id 
                AND trs.project_id = #{projectId}
            )
        </if>
        <if test="moduleId != null">
            AND EXISTS (
                SELECT 1 FROM TestReportSummaries trs 
                JOIN Modules m ON m.project_id = trs.project_id
                WHERE trs.report_id = TestCaseResults.report_id 
                AND m.module_id = #{moduleId}
            )
        </if>
        <if test="environment != null and environment != ''">
            AND environment = #{environment}
        </if>
    </select>

    <!-- 鑾峰彇涓婂懆鍚屾湡鏁版嵁锛堢敤浜庡姣旓級 -->
    <select id="getLastWeekSummary" resultType="com.victor.iatms.entity.dto.SummaryDTO">
        SELECT 
            COUNT(*) as totalExecutions,
            COUNT(DISTINCT ref_id) as totalCases,
            SUM(CASE WHEN status = 'passed' THEN 1 ELSE 0 END) as passed,
            SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed,
            SUM(CASE WHEN status = 'broken' THEN 1 ELSE 0 END) as broken,
            SUM(CASE WHEN status = 'skipped' THEN 1 ELSE 0 END) as skipped,
            ROUND((SUM(CASE WHEN status = 'passed' THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0), 2) as successRate,
            ROUND(AVG(duration), 0) as avgDuration
        FROM TestCaseResults
        WHERE is_deleted = FALSE
        <if test="lastWeekStart != null">
            AND start_time &gt;= #{lastWeekStart}
        </if>
        <if test="lastWeekEnd != null">
            AND start_time &lt;= #{lastWeekEnd}
        </if>
        <if test="projectId != null">
            AND EXISTS (
                SELECT 1 FROM TestReportSummaries trs 
                WHERE trs.report_id = TestCaseResults.report_id 
                AND trs.project_id = #{projectId}
            )
        </if>
        <if test="moduleId != null">
            AND EXISTS (
                SELECT 1 FROM TestReportSummaries trs 
                JOIN Modules m ON m.project_id = trs.project_id
                WHERE trs.report_id = TestCaseResults.report_id 
                AND m.module_id = #{moduleId}
            )
        </if>
        <if test="environment != null and environment != ''">
            AND environment = #{environment}
        </if>
    </select>

    <!-- ========== 涓汉娴嬭瘯姒傚喌鐩稿叧SQL ========== -->

    <!-- 鑾峰彇鐢ㄦ埛鍩烘湰淇℃伅 -->
    <select id="getUserInfo" resultType="com.victor.iatms.entity.dto.UserInfoDTO">
        SELECT 
            user_id as userId,
            name,
            avatar_url as avatarUrl,
            department,
            position,
            last_login as lastLogin,
            created_at as memberSince
        FROM Users
        WHERE user_id = #{userId}
        AND is_deleted = FALSE
    </select>

    <!-- 鑾峰彇鐢ㄦ埛鎵ц缁熻淇℃伅 -->
    <select id="getUserExecutionStats" resultType="com.victor.iatms.entity.dto.ExecutionStatsDTO">
        SELECT 
            COUNT(*) as totalExecutions,
            ROUND((SUM(CASE WHEN tcr.status = 'passed' THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0), 2) as successRate,
            ROUND(AVG(tcr.duration), 0) as avgDuration,
            (SELECT COUNT(*) FROM TestCases tc WHERE tc.created_by = #{userId} AND tc.is_deleted = FALSE) as casesCreated,
            (SELECT COUNT(*) FROM TestCases tc WHERE tc.updated_by = #{userId} AND tc.is_deleted = FALSE) as casesMaintained,
            (SELECT COUNT(*) FROM TestCaseResults tcr2 
             JOIN TestReportSummaries trs2 ON trs2.report_id = tcr2.report_id 
             WHERE tcr2.status IN ('failed', 'broken') 
             AND trs2.generated_by = #{userId}
             AND tcr2.is_deleted = FALSE) as bugsFound
        FROM TestCaseResults tcr
        JOIN TestReportSummaries trs ON trs.report_id = tcr.report_id
        WHERE trs.generated_by = #{userId}
        AND tcr.is_deleted = FALSE
        <if test="startTime != null">
            AND tcr.start_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND tcr.start_time &lt;= #{endTime}
        </if>
    </select>

    <!-- 鑾峰彇鐢ㄦ埛椤圭洰缁熻姒傝 -->
    <select id="getUserProjectStats" resultType="com.victor.iatms.entity.dto.ProjectStatsDTO">
        SELECT 
            trs.project_id as projectId,
            p.project_name as projectName,
            COUNT(*) as executions,
            ROUND((SUM(CASE WHEN tcr.status = 'passed' THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0), 2) as successRate,
            ROUND(AVG(tcr.duration), 0) as avgDuration
        FROM TestCaseResults tcr
        JOIN TestReportSummaries trs ON trs.report_id = tcr.report_id
        JOIN Projects p ON p.project_id = trs.project_id
        WHERE trs.generated_by = #{userId}
        AND tcr.is_deleted = FALSE
        <if test="startTime != null">
            AND tcr.start_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND tcr.start_time &lt;= #{endTime}
        </if>
        GROUP BY trs.project_id, p.project_name
        ORDER BY executions DESC
        LIMIT 5
    </select>

    <!-- 鑾峰彇鐢ㄦ埛鏈€杩戞椿鍔ㄨ褰?-->
    <select id="getUserRecentActivity" resultType="com.victor.iatms.entity.dto.RecentActivityDTO">
        SELECT 
            log_id as activityId,
            operation_type as type,
            CONCAT(operation_type, ' ', target_name) as description,
            target_id,
            target_name,
            timestamp,
            JSON_OBJECT(
                'status', status,
                'request_method', request_method,
                'request_path', request_path
            ) as details
        FROM Logs
        WHERE user_id = #{userId}
        ORDER BY timestamp DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 鑾峰彇鐢ㄦ埛寰呭姙浜嬮」 -->
    <select id="getUserPendingTasks" resultType="com.victor.iatms.entity.dto.PendingTaskDTO">
        SELECT 
            task_id as taskId,
            task_type as type,
            task_title as title,
            priority,
            due_date as dueDate,
            assigner,
            progress
        FROM Tasks
        WHERE assignee_id = #{userId}
        AND status IN ('pending', 'in_progress')
        AND is_deleted = FALSE
        ORDER BY priority DESC, due_date ASC
    </select>

    <!-- 鑾峰彇绯荤粺鐘舵€佷俊鎭?-->
    <select id="getSystemStatus" resultType="com.victor.iatms.entity.dto.SystemStatusDTO">
        SELECT 
            (SELECT COUNT(*) FROM TestCases WHERE is_deleted = FALSE) as totalCases,
            (SELECT COUNT(*) FROM Projects WHERE is_deleted = FALSE) as activeProjects,
            (SELECT COUNT(*) FROM TestCaseResults 
             WHERE DATE(start_time) = CURDATE() 
             AND is_deleted = FALSE) as todayExecutions,
            'good' as systemHealth
    </select>

    <!-- 鑾峰彇鐢ㄦ埛璐ㄩ噺鍋ュ悍璇勫垎 -->
    <select id="getUserHealthScore" resultType="com.victor.iatms.entity.dto.HealthScoreDTO">
        SELECT 
            ROUND(
                (COALESCE(execution_quality, 0) + COALESCE(case_coverage, 0) + COALESCE(defect_density, 0)) / 3, 0
            ) as overall,
            COALESCE(execution_quality, 85) as executionQuality,
            COALESCE(case_coverage, 75) as caseCoverage,
            COALESCE(defect_density, 20) as defectDensity,
            'improving' as trend
        FROM (
            SELECT 
                CASE 
                    WHEN success_rate >= 90 THEN 95
                    WHEN success_rate >= 80 THEN 85
                    WHEN success_rate >= 70 THEN 75
                    ELSE 65
                END as execution_quality,
                CASE 
                    WHEN case_count >= 50 THEN 90
                    WHEN case_count >= 30 THEN 80
                    WHEN case_count >= 20 THEN 70
                    ELSE 60
                END as case_coverage,
                CASE 
                    WHEN bug_count &lt;= 10 THEN 90
                    WHEN bug_count &lt;= 20 THEN 80
                    WHEN bug_count &lt;= 30 THEN 70
                    ELSE 60
                END as defect_density
            FROM (
                SELECT 
                    ROUND((SUM(CASE WHEN tcr.status = 'passed' THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0), 2) as success_rate,
                    (SELECT COUNT(*) FROM TestCases tc WHERE tc.created_by = #{userId} AND tc.is_deleted = FALSE) as case_count,
                    (SELECT COUNT(*) FROM TestCaseResults tcr2 
                     JOIN TestReportSummaries trs2 ON trs2.report_id = tcr2.report_id 
                     WHERE tcr2.status IN ('failed', 'broken') 
                     AND trs2.generated_by = #{userId}
                     AND tcr2.is_deleted = FALSE) as bug_count
                FROM TestCaseResults tcr
                JOIN TestReportSummaries trs ON trs.report_id = tcr.report_id
                WHERE trs.generated_by = #{userId}
                AND tcr.is_deleted = FALSE
                <if test="startTime != null">
                    AND tcr.start_time &gt;= #{startTime}
                </if>
                <if test="endTime != null">
                    AND tcr.start_time &lt;= #{endTime}
                </if>
            ) stats
        ) scores
    </select>

    <!-- 缁熻椤圭洰涓嬮€氳繃鐨勬祴璇曠敤渚嬬粨鏋滄暟 -->
    <select id="countPassedTestCasesByProjectId" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT tcr.result_id)
        FROM TestCaseResults tcr
        INNER JOIN TestCases tc ON tcr.task_type = 'test_case' AND tcr.ref_id = tc.case_id
        INNER JOIN Apis a ON tc.api_id = a.api_id
        INNER JOIN Modules m ON a.module_id = m.module_id
        WHERE m.project_id = #{projectId}
          AND tcr.status = 'passed'
          AND tc.is_deleted = 0
          AND tcr.is_deleted = 0
          AND a.is_deleted = 0
          AND m.is_deleted = 0
    </select>

    <!-- 缁熻椤圭洰涓嬪け璐ョ殑娴嬭瘯鐢ㄤ緥缁撴灉鏁?-->
    <select id="countFailedTestCasesByProjectId" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT tcr.result_id)
        FROM TestCaseResults tcr
        INNER JOIN TestCases tc ON tcr.task_type = 'test_case' AND tcr.ref_id = tc.case_id
        INNER JOIN Apis a ON tc.api_id = a.api_id
        INNER JOIN Modules m ON a.module_id = m.module_id
        WHERE m.project_id = #{projectId}
          AND tcr.status IN ('failed', 'error', 'broken')
          AND tc.is_deleted = 0
          AND tcr.is_deleted = 0
          AND a.is_deleted = 0
          AND m.is_deleted = 0
    </select>

    <!-- 鑾峰彇椤圭洰鏈€杩戜竴娆℃墽琛屾椂闂?-->
    <select id="getLatestExecutionTimeByProjectId" resultType="java.lang.String">
        SELECT DATE_FORMAT(MAX(ter.start_time), '%Y-%m-%d %H:%i:%s') as last_execution_time
        FROM TestExecutionRecords ter
        WHERE ter.execution_scope = 'project'
          AND ter.ref_id = #{projectId}
          AND ter.is_deleted = 0
    </select>

    <!-- 缁熻椤圭洰涓嬫祴璇曟墽琛岃褰曟€绘暟 -->
    <select id="countExecutionRecordsByProjectId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM TestExecutionRecords
        WHERE execution_scope = 'project'
          AND ref_id = #{projectId}
          AND is_deleted = 0
    </select>

    <!-- 统计模块下通过的测试用例结果数 -->
    <select id="countPassedTestCasesByModuleId" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT tcr.result_id)
        FROM TestCaseResults tcr
        INNER JOIN TestCases tc ON tcr.task_type = 'test_case' AND tcr.ref_id = tc.case_id
        INNER JOIN Apis a ON tc.api_id = a.api_id
        WHERE a.module_id = #{moduleId}
          AND tcr.status = 'passed'
          AND tc.is_deleted = 0
          AND tcr.is_deleted = 0
          AND a.is_deleted = 0
    </select>

    <!-- 统计模块下失败的测试用例结果数 -->
    <select id="countFailedTestCasesByModuleId" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT tcr.result_id)
        FROM TestCaseResults tcr
        INNER JOIN TestCases tc ON tcr.task_type = 'test_case' AND tcr.ref_id = tc.case_id
        INNER JOIN Apis a ON tc.api_id = a.api_id
        WHERE a.module_id = #{moduleId}
          AND tcr.status IN ('failed', 'error', 'broken')
          AND tc.is_deleted = 0
          AND tcr.is_deleted = 0
          AND a.is_deleted = 0
    </select>

    <!-- 获取模块最近一次执行时间 -->
    <select id="getLatestExecutionTimeByModuleId" resultType="java.lang.String">
        SELECT DATE_FORMAT(MAX(ter.start_time), '%Y-%m-%d %H:%i:%s') as last_execution_time
        FROM TestExecutionRecords ter
        WHERE ter.execution_scope = 'module'
          AND ter.ref_id = #{moduleId}
          AND ter.is_deleted = 0
    </select>

    <!-- 统计模块下测试执行记录总数 -->
    <select id="countExecutionRecordsByModuleId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM TestExecutionRecords
        WHERE execution_scope = 'module'
          AND ref_id = #{moduleId}
          AND is_deleted = 0
          AND is_deleted = 0
    </select>
</mapper>
