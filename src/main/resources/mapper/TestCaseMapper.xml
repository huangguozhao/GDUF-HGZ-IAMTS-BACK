<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.victor.iatms.mappers.TestCaseMapper">

    <!-- 测试用例结果映射 -->
    <resultMap id="TestCaseMap" type="com.victor.iatms.entity.po.TestCase">
        <id column="case_id" property="caseId"/>
        <result column="case_code" property="caseCode"/>
        <result column="api_id" property="apiId"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="priority" property="priority"/>
        <result column="severity" property="severity"/>
        <result column="tags" property="tags"/>
        <result column="pre_conditions" property="preConditions"/>
        <result column="test_steps" property="testSteps"/>
        <result column="request_override" property="requestOverride"/>
        <result column="expected_http_status" property="expectedHttpStatus"/>
        <result column="expected_response_schema" property="expectedResponseSchema"/>
        <result column="expected_response_body" property="expectedResponseBody"/>
        <result column="assertions" property="assertions"/>
        <result column="extractors" property="extractors"/>
        <result column="validators" property="validators"/>
        <result column="is_enabled" property="isEnabled"/>
        <result column="is_template" property="isTemplate"/>
        <result column="template_id" property="templateId"/>
        <result column="version" property="version"/>
        <result column="created_by" property="createdBy"/>
        <result column="updated_by" property="updatedBy"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="deleted_at" property="deletedAt"/>
        <result column="deleted_by" property="deletedBy"/>
    </resultMap>

    <!-- 创建测试用例响应结果映射 -->
    <resultMap id="CreateTestCaseResponseMap" type="com.victor.iatms.entity.dto.CreateTestCaseResponseDTO">
        <id column="case_id" property="caseId"/>
        <result column="case_code" property="caseCode"/>
        <result column="api_id" property="apiId"/>
        <result column="name" property="name"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 插入测试用例 -->
    <insert id="insert" parameterType="com.victor.iatms.entity.po.TestCase" useGeneratedKeys="true" keyProperty="caseId">
        INSERT INTO TestCases (
            case_code,
            api_id,
            name,
            description,
            priority,
            severity,
            tags,
            pre_conditions,
            test_steps,
            request_override,
            expected_http_status,
            expected_response_schema,
            expected_response_body,
            assertions,
            extractors,
            validators,
            is_enabled,
            is_template,
            template_id,
            version,
            created_by,
            updated_by,
            created_at,
            updated_at,
            is_deleted
        ) VALUES (
            #{caseCode},
            #{apiId},
            #{name},
            #{description},
            #{priority},
            #{severity},
            #{tags},
            #{preConditions},
            #{testSteps},
            #{requestOverride},
            #{expectedHttpStatus},
            #{expectedResponseSchema},
            #{expectedResponseBody},
            #{assertions},
            #{extractors},
            #{validators},
            #{isEnabled},
            #{isTemplate},
            #{templateId},
            #{version},
            #{createdBy},
            #{updatedBy},
            #{createdAt},
            #{updatedAt},
            #{isDeleted}
        )
    </insert>

    <!-- 根据ID查询测试用例 -->
    <select id="selectById" resultMap="TestCaseMap">
        SELECT 
            case_id,
            case_code,
            api_id,
            name,
            description,
            priority,
            severity,
            tags,
            pre_conditions,
            test_steps,
            request_override,
            expected_http_status,
            expected_response_schema,
            expected_response_body,
            assertions,
            extractors,
            validators,
            is_enabled,
            is_template,
            template_id,
            version,
            created_by,
            updated_by,
            created_at,
            updated_at,
            is_deleted,
            deleted_at,
            deleted_by
        FROM TestCases
        WHERE case_id = #{caseId}
    </select>

    <!-- 检查用例编码在指定接口下是否存在 -->
    <select id="checkCaseCodeExists" resultType="int">
        SELECT COUNT(*)
        FROM TestCases
        WHERE case_code = #{caseCode}
          AND api_id = #{apiId}
          AND is_deleted = FALSE
    </select>

    <!-- 统计指定接口下的测试用例数量 -->
    <select id="countByApiId" resultType="int">
        SELECT COUNT(*)
        FROM TestCases
        WHERE api_id = #{apiId}
          AND is_deleted = FALSE
    </select>

    <!-- 根据测试用例ID获取创建后的测试用例详情 -->
    <select id="selectCreateTestCaseDetailById" resultMap="CreateTestCaseResponseMap">
        SELECT 
            case_id,
            case_code,
            api_id,
            name,
            created_at,
            updated_at
        FROM TestCases
        WHERE case_id = #{caseId}
          AND is_deleted = FALSE
    </select>

</mapper>