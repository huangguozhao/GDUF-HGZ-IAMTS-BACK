<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.victor.iatms.mappers.UserMapper">
    
    <!-- 用户信息结果映射 -->
    <resultMap id="UserResultMap" type="com.victor.iatms.entity.po.User">
        <id column="user_id" property="userId"/>
        <result column="name" property="name"/>
        <result column="email" property="email"/>
        <result column="avatar_url" property="avatarUrl"/>
        <result column="phone" property="phone"/>
        <result column="password" property="password"/>
        <result column="department_id" property="departmentId"/>
        <result column="employee_id" property="employeeId"/>
        <result column="creator_id" property="creatorId"/>
        <result column="last_login_time" property="lastLoginTime"/>
        <result column="position" property="position"/>
        <result column="description" property="description"/>
        <result column="status" property="status"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="deleted_at" property="deletedAt"/>
        <result column="deleted_by" property="deletedBy"/>
    </resultMap>
    
    <!-- 根据邮箱查询用户信息 -->
    <select id="findByEmail" parameterType="string" resultMap="UserResultMap">
        SELECT 
            user_id, name, email, avatar_url, phone, password, 
            department_id, employee_id, creator_id, last_login_time,
            position, description, status, created_at, updated_at,
            is_deleted, deleted_at, deleted_by
        FROM Users 
        WHERE email = #{email} 
        AND is_deleted = FALSE
    </select>
    
    <!-- 根据邮箱或手机号查询用户信息 -->
    <select id="findByEmailOrPhone" parameterType="string" resultMap="UserResultMap">
        SELECT 
            user_id, name, email, avatar_url, phone, password, 
            department_id, employee_id, creator_id, last_login_time,
            position, description, status, created_at, updated_at,
            is_deleted, deleted_at, deleted_by
        FROM Users 
        WHERE (email = #{account} OR phone = #{account})
        AND is_deleted = FALSE
    </select>
    
    <!-- 更新用户最后登录时间 -->
    <update id="updateLastLoginTime">
        UPDATE Users 
        SET last_login_time = #{lastLoginTime},
            updated_at = NOW()
        WHERE user_id = #{userId}
    </update>
    
    <!-- 更新用户密码 -->
    <update id="updatePassword">
        UPDATE Users 
        SET password = #{newPassword},
            updated_at = NOW()
        WHERE user_id = #{userId}
        AND is_deleted = FALSE
    </update>
    
    <!-- 根据用户ID查询用户信息 -->
    <select id="findById" parameterType="int" resultMap="UserResultMap">
        SELECT 
            user_id, name, email, avatar_url, phone, password, 
            department_id, employee_id, creator_id, last_login_time,
            position, description, status, created_at, updated_at,
            is_deleted, deleted_at, deleted_by
        FROM Users 
        WHERE user_id = #{userId}
        AND is_deleted = FALSE
    </select>
    
    <!-- 根据用户ID查询用户姓名 -->
    <select id="findNameById" parameterType="int" resultType="string">
        SELECT name
        FROM Users 
        WHERE user_id = #{userId}
        AND is_deleted = FALSE
    </select>
    
</mapper>