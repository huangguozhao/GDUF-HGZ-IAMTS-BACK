<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.victor.iatms.mappers.ModuleMapper">

    <!-- 模块基础信息结果映射 -->
    <resultMap id="ModuleMap" type="com.victor.iatms.entity.po.Module">
        <id column="module_id" property="moduleId"/>
        <result column="module_code" property="moduleCode"/>
        <result column="project_id" property="projectId"/>
        <result column="parent_module_id" property="parentModuleId"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="status" property="status"/>
        <result column="owner_id" property="ownerId"/>
        <result column="tags" property="tags"/>
        <result column="created_by" property="createdBy"/>
        <result column="updated_by" property="updatedBy"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="deleted_at" property="deletedAt"/>
        <result column="deleted_by" property="deletedBy"/>
    </resultMap>

    <!-- 创建模块响应结果映射 -->
    <resultMap id="CreateModuleResponseMap" type="com.victor.iatms.entity.dto.CreateModuleResponseDTO">
        <id column="module_id" property="moduleId"/>
        <result column="module_code" property="moduleCode"/>
        <result column="project_id" property="projectId"/>
        <result column="parent_module_id" property="parentModuleId"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="status" property="status"/>
        <result column="owner_id" property="ownerId"/>
        <result column="owner_name" property="ownerName"/>
        <result column="tags" property="tags" typeHandler="com.victor.iatms.utils.JsonTypeHandler"/>
        <result column="created_by" property="createdBy"/>
        <result column="creator_name" property="creatorName"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 修改模块响应结果映射 -->
    <resultMap id="UpdateModuleResponseMap" type="com.victor.iatms.entity.dto.UpdateModuleResponseDTO">
        <id column="module_id" property="moduleId"/>
        <result column="module_code" property="moduleCode"/>
        <result column="project_id" property="projectId"/>
        <result column="parent_module_id" property="parentModuleId"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="status" property="status"/>
        <result column="owner_id" property="ownerId"/>
        <result column="tags" property="tags" typeHandler="com.victor.iatms.utils.JsonTypeHandler"/>
        <result column="created_by" property="createdBy"/>
        <result column="creator_name" property="creatorName"/>
        <result column="updated_by" property="updatedBy"/>
        <result column="updater_name" property="updaterName"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="is_deleted" property="isDeleted"/>
        <association property="ownerInfo" javaType="com.victor.iatms.entity.dto.OwnerInfoDTO">
            <result column="owner_id" property="userId"/>
            <result column="owner_name" property="name"/>
            <result column="owner_avatar_url" property="avatarUrl"/>
        </association>
    </resultMap>

    <!-- 插入模块 -->
    <insert id="insert" parameterType="com.victor.iatms.entity.po.Module" useGeneratedKeys="true" keyProperty="moduleId">
        INSERT INTO Modules (
            module_code,
            project_id,
            parent_module_id,
            name,
            description,
            sort_order,
            status,
            owner_id,
            tags,
            created_by,
            updated_by,
            created_at,
            updated_at,
            is_deleted
        ) VALUES (
            #{moduleCode},
            #{projectId},
            #{parentModuleId},
            #{name},
            #{description},
            #{sortOrder},
            #{status},
            #{ownerId},
            #{tags},
            #{createdBy},
            #{updatedBy},
            #{createdAt},
            #{updatedAt},
            #{isDeleted}
        )
    </insert>

    <!-- 根据ID查询模块 -->
    <select id="selectById" resultMap="ModuleMap">
        SELECT 
            module_id,
            module_code,
            project_id,
            parent_module_id,
            name,
            description,
            sort_order,
            status,
            owner_id,
            tags,
            created_by,
            updated_by,
            created_at,
            updated_at,
            is_deleted,
            deleted_at,
            deleted_by
        FROM Modules
        WHERE module_id = #{moduleId}
    </select>

    <!-- 检查模块编码是否存在 -->
    <select id="checkModuleCodeExists" resultType="int">
        SELECT COUNT(*)
        FROM Modules
        WHERE module_code = #{moduleCode}
          AND project_id = #{projectId}
          AND is_deleted = FALSE
    </select>

    <!-- 根据模块ID获取模块详情（包含关联信息） -->
    <select id="selectModuleDetailById" resultMap="CreateModuleResponseMap">
        SELECT 
            m.module_id,
            m.module_code,
            m.project_id,
            m.parent_module_id,
            m.name,
            m.description,
            m.sort_order,
            m.status,
            m.owner_id,
            owner.name as owner_name,
            m.tags,
            m.created_by,
            creator.name as creator_name,
            m.created_at,
            m.updated_at
        FROM Modules m
        LEFT JOIN Users owner ON m.owner_id = owner.user_id
        LEFT JOIN Users creator ON m.created_by = creator.user_id
        WHERE m.module_id = #{moduleId}
          AND m.is_deleted = FALSE
    </select>

    <!-- 软删除模块 -->
    <update id="deleteById">
        UPDATE Modules 
        SET is_deleted = TRUE,
            deleted_at = NOW(),
            deleted_by = #{deletedBy},
            status = 'inactive',
            updated_at = NOW()
        WHERE module_id = #{moduleId}
          AND is_deleted = FALSE
    </update>

    <!-- 统计子模块数量 -->
    <select id="countChildModules" resultType="int">
        SELECT COUNT(*)
        FROM Modules
        WHERE parent_module_id = #{moduleId}
          AND is_deleted = FALSE
    </select>

    <!-- 统计模块下的接口数量 -->
    <select id="countModuleApis" resultType="int">
        SELECT COUNT(*)
        FROM Apis
        WHERE module_id = #{moduleId}
          AND is_deleted = FALSE
    </select>

    <!-- 检查模块是否正在被使用 -->
    <select id="isModuleInUse" resultType="boolean">
        SELECT CASE 
            WHEN EXISTS (
                SELECT 1 FROM TestCases tc
                LEFT JOIN Apis a ON tc.api_id = a.api_id
                WHERE a.module_id = #{moduleId}
                  AND tc.is_deleted = FALSE
                  AND a.is_deleted = FALSE
            ) THEN TRUE
            WHEN EXISTS (
                SELECT 1 FROM TestSuiteModules tsm
                WHERE tsm.module_id = #{moduleId}
                  AND tsm.is_deleted = FALSE
            ) THEN TRUE
            WHEN EXISTS (
                SELECT 1 FROM TestPlans tp
                WHERE tp.module_id = #{moduleId}
                  AND tp.is_deleted = FALSE
            ) THEN TRUE
            ELSE FALSE
        END
    </select>

    <!-- 更新模块信息 -->
    <update id="updateById" parameterType="com.victor.iatms.entity.po.Module">
        UPDATE Modules 
        <set>
            <if test="moduleCode != null">module_code = #{moduleCode},</if>
            <if test="name != null">name = #{name},</if>
            <if test="description != null">description = #{description},</if>
            <if test="parentModuleId != null">parent_module_id = #{parentModuleId},</if>
            <if test="sortOrder != null">sort_order = #{sortOrder},</if>
            <if test="status != null">status = #{status},</if>
            <if test="ownerId != null">owner_id = #{ownerId},</if>
            <if test="tags != null">tags = #{tags, typeHandler=com.victor.iatms.utils.JsonTypeHandler},</if>
            <if test="updatedBy != null">updated_by = #{updatedBy},</if>
            <if test="updatedAt != null">updated_at = #{updatedAt},</if>
        </set>
        WHERE module_id = #{moduleId}
          AND is_deleted = FALSE
    </update>

    <!-- 检查模块编码在指定项目下是否存在（排除指定模块） -->
    <select id="checkModuleCodeExistsExcludeSelf" resultType="int">
        SELECT COUNT(*)
        FROM Modules
        WHERE module_code = #{moduleCode}
          AND project_id = #{projectId}
          AND module_id != #{excludeModuleId}
          AND is_deleted = FALSE
    </select>

    <!-- 根据模块ID获取更新后的模块详情（包含关联信息） -->
    <select id="selectUpdateModuleDetailById" resultMap="UpdateModuleResponseMap">
        SELECT 
            m.module_id,
            m.module_code,
            m.project_id,
            m.parent_module_id,
            m.name,
            m.description,
            m.sort_order,
            m.status,
            m.owner_id,
            owner.name as owner_name,
            owner.avatar_url as owner_avatar_url,
            m.tags,
            m.created_by,
            creator.name as creator_name,
            m.updated_by,
            updater.name as updater_name,
            m.created_at,
            m.updated_at,
            m.is_deleted
        FROM Modules m
        LEFT JOIN Users owner ON m.owner_id = owner.user_id
        LEFT JOIN Users creator ON m.created_by = creator.user_id
        LEFT JOIN Users updater ON m.updated_by = updater.user_id
        WHERE m.module_id = #{moduleId}
          AND m.is_deleted = FALSE
    </select>

    <!-- 接口信息结果映射 -->
    <resultMap id="ApiMap" type="com.victor.iatms.entity.dto.ApiDTO">
        <id column="api_id" property="apiId"/>
        <result column="api_code" property="apiCode"/>
        <result column="module_id" property="moduleId"/>
        <result column="name" property="name"/>
        <result column="method" property="method"/>
        <result column="path" property="path"/>
        <result column="base_url" property="baseUrl"/>
        <result column="full_url" property="fullUrl"/>
        <result column="request_parameters" property="requestParameters" typeHandler="com.victor.iatms.utils.JsonTypeHandler"/>
        <result column="path_parameters" property="pathParameters" typeHandler="com.victor.iatms.utils.JsonTypeHandler"/>
        <result column="request_headers" property="requestHeaders" typeHandler="com.victor.iatms.utils.JsonTypeHandler"/>
        <result column="request_body" property="requestBody"/>
        <result column="request_body_type" property="requestBodyType"/>
        <result column="response_body_type" property="responseBodyType"/>
        <result column="description" property="description"/>
        <result column="status" property="status"/>
        <result column="version" property="version"/>
        <result column="timeout_seconds" property="timeoutSeconds"/>
        <result column="auth_type" property="authType"/>
        <result column="auth_config" property="authConfig" typeHandler="com.victor.iatms.utils.JsonTypeHandler"/>
        <result column="tags" property="tags" typeHandler="com.victor.iatms.utils.JsonTypeHandler"/>
        <result column="examples" property="examples" typeHandler="com.victor.iatms.utils.JsonTypeHandler"/>
        <result column="precondition_count" property="preconditionCount"/>
        <result column="test_case_count" property="testCaseCount"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <association property="creatorInfo" javaType="com.victor.iatms.entity.dto.CreatorInfoDTO">
            <result column="creator_id" property="userId"/>
            <result column="creator_name" property="name"/>
            <result column="creator_avatar_url" property="avatarUrl"/>
        </association>
    </resultMap>

    <!-- 查询接口列表 -->
    <select id="selectApiList" resultMap="ApiMap">
        SELECT 
            a.api_id,
            a.api_code,
            a.module_id,
            a.name,
            a.method,
            a.path,
            a.base_url,
            a.full_url,
            a.request_parameters,
            a.path_parameters,
            a.request_headers,
            a.request_body,
            a.request_body_type,
            a.response_body_type,
            a.description,
            a.status,
            a.version,
            a.timeout_seconds,
            a.auth_type,
            a.auth_config,
            a.tags,
            a.examples,
            a.created_by as creator_id,
            creator.name as creator_name,
            creator.avatar_url as creator_avatar_url,
            a.created_at,
            a.updated_at
            <if test="includeStatistics">
                ,(SELECT COUNT(*) FROM ApiPreconditions ap WHERE ap.api_id = a.api_id AND ap.is_deleted = FALSE) as precondition_count,
                (SELECT COUNT(*) FROM TestCases tc WHERE tc.api_id = a.api_id AND tc.is_deleted = FALSE) as test_case_count
            </if>
        FROM Apis a
        LEFT JOIN Users creator ON a.created_by = creator.user_id
        <where>
            a.module_id = #{moduleId}
            <if test="!includeDeleted">
                AND a.is_deleted = FALSE
            </if>
            <if test="method != null and method != ''">
                AND a.method = #{method}
            </if>
            <if test="status != null and status != ''">
                AND a.status = #{status}
            </if>
            <if test="authType != null and authType != ''">
                AND a.auth_type = #{authType}
            </if>
            <if test="searchKeyword != null and searchKeyword != ''">
                AND (a.name LIKE CONCAT('%', #{searchKeyword}, '%') 
                     OR a.description LIKE CONCAT('%', #{searchKeyword}, '%')
                     OR a.path LIKE CONCAT('%', #{searchKeyword}, '%'))
            </if>
            <if test="tags != null and tags.size() > 0">
                AND JSON_CONTAINS(a.tags, JSON_ARRAY(
                    <foreach collection="tags" item="tag" separator=",">
                        #{tag}
                    </foreach>
                ))
            </if>
        </where>
        <if test="sortBy != null and sortBy != ''">
            ORDER BY 
            <choose>
                <when test="sortBy == 'name'">a.name</when>
                <when test="sortBy == 'method'">a.method</when>
                <when test="sortBy == 'path'">a.path</when>
                <when test="sortBy == 'created_at'">a.created_at</when>
                <when test="sortBy == 'updated_at'">a.updated_at</when>
                <otherwise>a.created_at</otherwise>
            </choose>
            <if test="sortOrder != null and sortOrder != ''">
                <choose>
                    <when test="sortOrder == 'asc'">ASC</when>
                    <when test="sortOrder == 'desc'">DESC</when>
                    <otherwise>DESC</otherwise>
                </choose>
            </if>
        </if>
        <if test="pageSize != null and offset != null">
            LIMIT #{pageSize} OFFSET #{offset}
        </if>
    </select>

    <!-- 统计接口列表总数 -->
    <select id="countApiList" resultType="int">
        SELECT COUNT(*)
        FROM Apis a
        <where>
            a.module_id = #{moduleId}
            <if test="!includeDeleted">
                AND a.is_deleted = FALSE
            </if>
            <if test="method != null and method != ''">
                AND a.method = #{method}
            </if>
            <if test="status != null and status != ''">
                AND a.status = #{status}
            </if>
            <if test="authType != null and authType != ''">
                AND a.auth_type = #{authType}
            </if>
            <if test="searchKeyword != null and searchKeyword != ''">
                AND (a.name LIKE CONCAT('%', #{searchKeyword}, '%') 
                     OR a.description LIKE CONCAT('%', #{searchKeyword}, '%')
                     OR a.path LIKE CONCAT('%', #{searchKeyword}, '%'))
            </if>
            <if test="tags != null and tags.size() > 0">
                AND JSON_CONTAINS(a.tags, JSON_ARRAY(
                    <foreach collection="tags" item="tag" separator=",">
                        #{tag}
                    </foreach>
                ))
            </if>
        </where>
    </select>

    <!-- 查询接口统计摘要 -->
    <select id="selectApiSummary" resultType="com.victor.iatms.entity.dto.ApiSummaryDTO">
        SELECT 
            COUNT(*) as totalApis,
            JSON_OBJECT(
                'GET', SUM(CASE WHEN method = 'GET' THEN 1 ELSE 0 END),
                'POST', SUM(CASE WHEN method = 'POST' THEN 1 ELSE 0 END),
                'PUT', SUM(CASE WHEN method = 'PUT' THEN 1 ELSE 0 END),
                'DELETE', SUM(CASE WHEN method = 'DELETE' THEN 1 ELSE 0 END),
                'PATCH', SUM(CASE WHEN method = 'PATCH' THEN 1 ELSE 0 END),
                'HEAD', SUM(CASE WHEN method = 'HEAD' THEN 1 ELSE 0 END),
                'OPTIONS', SUM(CASE WHEN method = 'OPTIONS' THEN 1 ELSE 0 END)
            ) as byMethod,
            JSON_OBJECT(
                'active', SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END),
                'inactive', SUM(CASE WHEN status = 'inactive' THEN 1 ELSE 0 END),
                'deprecated', SUM(CASE WHEN status = 'deprecated' THEN 1 ELSE 0 END)
            ) as byStatus,
            JSON_OBJECT(
                'none', SUM(CASE WHEN auth_type = 'none' THEN 1 ELSE 0 END),
                'basic', SUM(CASE WHEN auth_type = 'basic' THEN 1 ELSE 0 END),
                'bearer', SUM(CASE WHEN auth_type = 'bearer' THEN 1 ELSE 0 END),
                'api_key', SUM(CASE WHEN auth_type = 'api_key' THEN 1 ELSE 0 END),
                'oauth2', SUM(CASE WHEN auth_type = 'oauth2' THEN 1 ELSE 0 END)
            ) as byAuthType
        FROM Apis
        WHERE module_id = #{moduleId}
          AND is_deleted = FALSE
    </select>

</mapper>
