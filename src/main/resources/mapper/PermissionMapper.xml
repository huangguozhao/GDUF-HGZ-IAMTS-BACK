<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.victor.iatms.mappers.PermissionMapper">

    <resultMap id="PermissionListItemMap" type="com.victor.iatms.entity.dto.PermissionListItemDTO">
        <id column="permission_id" property="permissionId"/>
        <result column="permission_name" property="permissionName"/>
        <result column="description" property="description"/>
        <result column="role_count" property="roleCount"/>
        <result column="is_assigned" property="isAssigned"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="deleted_at" property="deletedAt"/>
    </resultMap>

    <select id="selectPermissionList" resultMap="PermissionListItemMap">
        SELECT p.permission_id,
               p.permission_name,
               p.description,
               p.created_at,
               p.updated_at,
               p.is_deleted,
               p.deleted_at,
               (SELECT COUNT(1) FROM RolePermissions rp WHERE rp.permission_id = p.permission_id) AS role_count,
               <choose>
                   <when test="q.roleId != null">
                       (SELECT CASE WHEN COUNT(1) > 0 THEN TRUE ELSE FALSE END
                        FROM RolePermissions rp2
                        WHERE rp2.role_id = #{q.roleId} AND rp2.permission_id = p.permission_id) AS is_assigned
                   </when>
                   <otherwise>
                       FALSE AS is_assigned
                   </otherwise>
               </choose>
        FROM Permissions p
        <where>
            <if test="q.permissionName != null and q.permissionName != ''">
                AND p.permission_name LIKE CONCAT('%', #{q.permissionName}, '%')
            </if>
            <if test="q.includeDeleted == null or q.includeDeleted == false">
                AND p.is_deleted = FALSE
            </if>
        </where>
        ORDER BY p.created_at DESC
        LIMIT #{q.pageSize} OFFSET ${(q.page-1)*q.pageSize}
    </select>

    <select id="countPermissions" resultType="long">
        SELECT COUNT(1)
        FROM Permissions p
        <where>
            <if test="q.permissionName != null and q.permissionName != ''">
                AND p.permission_name LIKE CONCAT('%', #{q.permissionName}, '%')
            </if>
            <if test="q.includeDeleted == null or q.includeDeleted == false">
                AND p.is_deleted = FALSE
            </if>
        </where>
    </select>

    <select id="existsByIds" resultType="int">
        SELECT COUNT(1) FROM Permissions WHERE permission_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

</mapper>
