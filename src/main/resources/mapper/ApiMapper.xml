<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.victor.iatms.mappers.ApiMapper">

    <!-- 接口信息结果映射 -->
    <resultMap id="ApiResultMap" type="com.victor.iatms.entity.po.Api">
        <id column="api_id" property="apiId"/>
        <result column="api_code" property="apiCode"/>
        <result column="module_id" property="moduleId"/>
        <result column="name" property="name"/>
        <result column="method" property="method"/>
        <result column="path" property="path"/>
        <result column="base_url" property="baseUrl"/>
        <result column="full_url" property="fullUrl"/>
        <result column="request_parameters" property="requestParameters"/>
        <result column="path_parameters" property="pathParameters"/>
        <result column="request_headers" property="requestHeaders"/>
        <result column="request_body" property="requestBody"/>
        <result column="request_body_type" property="requestBodyType"/>
        <result column="response_body_type" property="responseBodyType"/>
        <result column="description" property="description"/>
        <result column="status" property="status"/>
        <result column="version" property="version"/>
        <result column="timeout_seconds" property="timeoutSeconds"/>
        <result column="auth_type" property="authType"/>
        <result column="auth_config" property="authConfig"/>
        <result column="tags" property="tags"/>
        <result column="examples" property="examples"/>
        <result column="created_by" property="createdBy"/>
        <result column="updated_by" property="updatedBy"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="deleted_at" property="deletedAt"/>
        <result column="deleted_by" property="deletedBy"/>
    </resultMap>

    <!-- 根据接口ID查询接口信息 -->
    <select id="findById" parameterType="int" resultMap="ApiResultMap">
        SELECT 
            api_id, api_code, module_id, name, method, path, base_url, full_url,
            request_parameters, path_parameters, request_headers, request_body,
            request_body_type, response_body_type, description, status, version,
            timeout_seconds, auth_type, auth_config, tags, examples,
            created_by, updated_by, created_at, updated_at,
            is_deleted, deleted_at, deleted_by
        FROM Apis 
        WHERE api_id = #{apiId}
        AND is_deleted = FALSE
    </select>

    <!-- 根据接口ID和状态查询接口信息 -->
    <select id="findByIdAndStatus" resultMap="ApiResultMap">
        SELECT 
            api_id, api_code, module_id, name, method, path, base_url, full_url,
            request_parameters, path_parameters, request_headers, request_body,
            request_body_type, response_body_type, description, status, version,
            timeout_seconds, auth_type, auth_config, tags, examples,
            created_by, updated_by, created_at, updated_at,
            is_deleted, deleted_at, deleted_by
        FROM Apis 
        WHERE api_id = #{apiId}
        AND status = #{status}
        AND is_deleted = FALSE
    </select>

    <!-- 根据ID查询接口 -->
    <select id="selectById" resultMap="ApiResultMap">
        SELECT 
            api_id, api_code, module_id, name, method, path, base_url, full_url,
            request_parameters, path_parameters, request_headers, request_body,
            request_body_type, response_body_type, description, status, version,
            timeout_seconds, auth_type, auth_config, tags, examples,
            created_by, updated_by, created_at, updated_at,
            is_deleted, deleted_at, deleted_by
        FROM Apis 
        WHERE api_id = #{apiId}
    </select>

    <!-- 软删除接口 -->
    <update id="deleteById">
        UPDATE Apis 
        SET is_deleted = TRUE,
            deleted_at = NOW(),
            deleted_by = #{deletedBy},
            status = 'inactive'
        WHERE api_id = #{apiId}
          AND is_deleted = FALSE
    </update>

    <!-- 统计接口下的前置条件数量 -->
    <select id="countPreconditionsByApiId" resultType="int">
        SELECT COUNT(*)
        FROM ApiPreconditions
        WHERE api_id = #{apiId}
          AND is_deleted = FALSE
    </select>

</mapper>
