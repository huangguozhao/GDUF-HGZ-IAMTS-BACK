# 模块统计接口实现说明

## 概述

为 `ModuleController` 添加了获取模块统计数据的接口，用于在前端展示模块的各项关键指标，提升用户体验。类似于项目统计接口的设计。

## 接口详情

### 1. API 端点

```
GET /api/modules/{moduleId}/statistics
```

### 2. 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| moduleId | Integer | 是 | 模块ID（路径参数） |

### 3. 响应数据结构

```json
{
  "code": 0,
  "msg": "查询模块统计数据成功",
  "data": {
    "moduleId": 1,
    "moduleName": "认证模块",
    "moduleCode": "AUTH_MODULE",
    "status": "active",
    "apiCount": 5,
    "testCaseCount": 15,
    "passedCount": 12,
    "failedCount": 2,
    "notExecutedCount": 1,
    "childModuleCount": 3,
    "executionRecordCount": 8,
    "passRate": 85.71,
    "lastExecutionTime": "2025-10-24 13:45:53",
    "createdAt": "2025-01-15 10:30:00",
    "updatedAt": "2025-10-24 12:00:00"
  }
}
```

### 4. 字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| moduleId | Integer | 模块ID |
| moduleName | String | 模块名称 |
| moduleCode | String | 模块编码 |
| status | String | 模块状态（active/inactive/archived） |
| apiCount | Integer | 接口总数（不包含已删除） |
| testCaseCount | Integer | 测试用例总数 |
| passedCount | Integer | 通过的测试用例数（基于最近的测试结果） |
| failedCount | Integer | 失败的测试用例数（包括 failed/error/broken） |
| notExecutedCount | Integer | 未执行的测试用例数（总数 - 已执行） |
| childModuleCount | Integer | 子模块总数 |
| executionRecordCount | Integer | 测试执行记录总数（scope='module'） |
| passRate | Double | 用例通过率（%，保留2位小数） |
| lastExecutionTime | String | 最近一次执行时间（格式：yyyy-MM-dd HH:mm:ss） |
| createdAt | String | 模块创建时间 |
| updatedAt | String | 模块最后更新时间 |

## 实现细节

### 1. 新增文件

- `src/main/java/com/victor/iatms/entity/dto/ModuleStatisticsDTO.java` - 模块统计数据DTO
- `test_module_statistics.bat` - 测试脚本
- `模块统计接口实现说明.md` - 本文档

### 2. 修改文件

#### Controller层
- `src/main/java/com/victor/iatms/controller/ModuleController.java`
  - 新增 `getModuleStatistics()` 方法

#### Service层
- `src/main/java/com/victor/iatms/service/ModuleService.java`
  - 新增 `getModuleStatistics()` 方法签名
  
- `src/main/java/com/victor/iatms/service/impl/ModuleServiceImpl.java`
  - 实现 `getModuleStatistics()` 方法
  - 添加 `TestExecutionMapper` 依赖注入

#### Mapper层
- `src/main/java/com/victor/iatms/mappers/ModuleMapper.java`
  - 新增 `countChildModules()` - 统计子模块数
  - 新增 `countModuleApis()` - 统计接口数

- `src/main/java/com/victor/iatms/mappers/TestExecutionMapper.java`
  - 新增 `countTestCasesByModuleId()` - 统计用例总数
  - 新增 `countPassedTestCasesByModuleId()` - 统计通过用例数
  - 新增 `countFailedTestCasesByModuleId()` - 统计失败用例数
  - 新增 `getLatestExecutionTimeByModuleId()` - 获取最近执行时间
  - 新增 `countExecutionRecordsByModuleId()` - 统计执行记录数

#### XML映射
- `src/main/resources/mapper/ModuleMapper.xml`
  - 添加 `countChildModules` SQL
  - 添加 `countModuleApis` SQL

- `src/main/resources/mapper/TestExecutionMapper.xml`
  - 添加 `countTestCasesByModuleId` SQL
  - 添加 `countPassedTestCasesByModuleId` SQL
  - 添加 `countFailedTestCasesByModuleId` SQL
  - 添加 `getLatestExecutionTimeByModuleId` SQL
  - 添加 `countExecutionRecordsByModuleId` SQL

## 数据库表关联说明

### 表结构关系（模块视角）
- `Modules` (module_id)
  - ← `Modules` (parent_module_id) - 子模块关系
  - ← `Apis` (module_id) - 接口关系
    - ← `TestCases` (api_id) - 测试用例关系
      - ← `TestCaseResults` (task_type='test_case', ref_id=case_id) - 测试结果关系
  - ← `TestExecutionRecords` (execution_scope='module', ref_id=module_id) - 执行记录关系

### SQL查询逻辑

1. **统计测试用例总数**：
   ```sql
   TestCases → Apis (通过 api_id) → 筛选 module_id
   ```

2. **统计测试用例结果**：
   ```sql
   TestCaseResults (task_type='test_case', ref_id)
   → TestCases (case_id, api_id)
   → Apis (api_id, module_id)
   → 筛选 module_id
   ```

3. **统计执行记录**：
   ```sql
   TestExecutionRecords 
   WHERE execution_scope='module' AND ref_id=moduleId
   ```

## 统计逻辑说明

### 通过率计算
```java
if (executedCount > 0) {
    double passRate = (passedCount * 100.0) / executedCount;
    statistics.setPassRate(Math.round(passRate * 100.0) / 100.0);
} else {
    statistics.setPassRate(0.0);
}
```

### 未执行数计算
```java
int executedCount = passedCount + failedCount;
int notExecutedCount = testCaseCount - executedCount;
statistics.setNotExecutedCount(notExecutedCount > 0 ? notExecutedCount : 0);
```

## 前端使用示例

```javascript
// 获取模块统计数据
async function getModuleStatistics(moduleId) {
  try {
    const response = await fetch(`/api/modules/${moduleId}/statistics`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.code === 0) {
      const stats = result.data;
      
      // 更新UI
      document.getElementById('module-name').textContent = stats.moduleName;
      document.getElementById('api-count').textContent = stats.apiCount;
      document.getElementById('test-case-count').textContent = stats.testCaseCount;
      document.getElementById('passed-count').textContent = stats.passedCount;
      document.getElementById('failed-count').textContent = stats.failedCount;
      document.getElementById('not-executed-count').textContent = stats.notExecutedCount;
      document.getElementById('child-module-count').textContent = stats.childModuleCount;
      document.getElementById('pass-rate').textContent = `${stats.passRate}%`;
      
      // 可以用于图表展示
      updateChart(stats);
    }
  } catch (error) {
    console.error('获取模块统计数据失败:', error);
  }
}
```

## 错误处理

| 错误场景 | HTTP状态码 | 错误信息 |
|----------|-----------|----------|
| 模块ID为空 | 400 | 模块ID不能为空 |
| 模块不存在 | 404 | 模块不存在 |
| 模块已删除 | 400 | 模块已被删除 |
| 系统异常 | 500 | 查询模块统计数据失败：{具体错误} |

## 性能优化建议

1. **缓存统计数据**
   - 统计数据变化不频繁，可以添加Redis缓存
   - 建议缓存时间：3-5分钟

2. **异步计算**
   - 对于大型模块，统计查询可能较慢
   - 可以考虑后台定时任务预计算统计数据

3. **索引优化**
   - 确保 `Apis.module_id` 字段有索引
   - 确保 `Modules.parent_module_id` 字段有索引
   - `TestCaseResults.task_type` 和 `status` 字段建议添加复合索引

## 测试

运行测试脚本：
```bash
test_module_statistics.bat
```

## 对比：项目统计 vs 模块统计

| 维度 | 项目统计 | 模块统计 |
|------|---------|---------|
| 接口路径 | `/projects/{id}/statistics` | `/modules/{id}/statistics` |
| 模块数 | ✅ 统计 | - |
| 子模块数 | - | ✅ 统计 |
| 接口数 | ✅ 统计 | ✅ 统计 |
| 用例数 | ✅ 统计 | ✅ 统计 |
| 执行记录 | scope='project' | scope='module' |
| 成员数 | ✅ 统计 | - |
| 报告数 | ✅ 统计 | - |

## 注意事项

1. 失败用例包括状态为 `failed`、`error`、`broken` 的用例
2. 通过率只计算已执行的用例（通过数 / (通过数 + 失败数)）
3. 所有统计都排除了已删除的数据
4. 模块状态包括：`active`（活跃）、`inactive`（不活跃）、`archived`（已归档）

## 问题修复历程

### 问题1：重复的SQL映射定义
**错误**：`Mapped Statements collection already contains key com.victor.iatms.mappers.TestExecutionMapper.countTestCasesByModuleId`

**原因**：在 `TestExecutionMapper.xml` 中存在重复的方法定义。

**解决**：删除新增的重复定义，保留原有定义。

### 问题2：方法重载冲突
**错误**：`查询模块统计数据失败：null`

**原因**：
1. `TestExecutionMapper` 接口中有两个同名方法 `countTestCasesByModuleId`：
   - 第117行：`countTestCasesByModuleId(moduleId, priorityList, tagsList, enabledOnly)` （原有）
   - 第587行：`countTestCasesByModuleId(moduleId)` （新增，重复）
2. MyBatis 不支持真正的方法重载，XML 中的 `id` 必须唯一
3. `ModuleServiceImpl` 调用时只传递了一个参数，但实际需要4个参数

**解决**：
1. 删除第587行的重复方法定义
2. 修改 `ModuleServiceImpl` 调用，传递完整参数：
   ```java
   testExecutionMapper.countTestCasesByModuleId(moduleId, null, null, null);
   ```

## 版本信息

- 实现日期：2025-10-24
- 实现人：AI Assistant
- 版本：v1.1（已修复方法重载冲突）

