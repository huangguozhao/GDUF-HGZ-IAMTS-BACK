# 删除接口API文档

## 接口概述

删除接口API提供了删除指定接口的功能，采用软删除方式，包含完整的业务规则验证，确保数据安全性和一致性。

## 接口详情

### 删除接口

**请求路径**: `/apis/{api_id}`  
**请求方式**: `DELETE`  
**接口描述**: 删除指定接口（软删除）

#### 请求参数

**请求头**:
- `Authorization` (string, 必须): 认证令牌，格式: `Bearer {token}`

**路径参数**:
- `api_id` (number, 必须): 要删除的接口ID

**请求体**: 无

#### 请求示例

```bash
# 删除接口
curl -X DELETE "http://localhost:8080/apis/1001" \
  -H "Authorization: Bearer your_token_here"

# 删除不存在的接口
curl -X DELETE "http://localhost:8080/apis/9999" \
  -H "Authorization: Bearer your_token_here"

# 删除已删除的接口
curl -X DELETE "http://localhost:8080/apis/1002" \
  -H "Authorization: Bearer your_token_here"

# 删除系统接口
curl -X DELETE "http://localhost:8080/apis/1004" \
  -H "Authorization: Bearer your_token_here"

# 删除存在测试用例的接口
curl -X DELETE "http://localhost:8080/apis/1005" \
  -H "Authorization: Bearer your_token_here"

# 删除存在前置条件的接口
curl -X DELETE "http://localhost:8080/apis/1006" \
  -H "Authorization: Bearer your_token_here"

# 删除正在被使用的接口
curl -X DELETE "http://localhost:8080/apis/1007" \
  -H "Authorization: Bearer your_token_here"
```

#### 响应数据

**成功响应** (HTTP 200):

```json
{
  "code": 1,
  "msg": "接口删除成功",
  "data": null
}
```

**失败响应**:

```json
// 接口不存在 (HTTP 200)
{
  "code": -4,
  "msg": "接口不存在",
  "data": null
}

// 接口已被删除 (HTTP 200)
{
  "code": 0,
  "msg": "接口已被删除",
  "data": null
}

// 权限不足 (HTTP 200)
{
  "code": -2,
  "msg": "权限不足，无法删除接口",
  "data": null
}

// 系统接口 (HTTP 200)
{
  "code": 0,
  "msg": "不能删除系统接口",
  "data": null
}

// 存在测试用例 (HTTP 200)
{
  "code": 0,
  "msg": "接口存在测试用例，无法删除",
  "data": null
}

// 存在前置条件 (HTTP 200)
{
  "code": 0,
  "msg": "接口存在前置条件配置，无法删除",
  "data": null
}

// 正在被使用 (HTTP 200)
{
  "code": 0,
  "msg": "接口正在被测试计划使用，无法删除",
  "data": null
}

// 认证失败 (HTTP 401)
{
  "code": -1,
  "msg": "认证失败，请重新登录",
  "data": null
}
```

## 业务逻辑说明

### 删除流程
1. **参数校验**: 验证接口ID
2. **接口验证**: 检查接口是否存在且未被删除
3. **权限检查**: 验证用户是否有接口管理权限
4. **系统接口检查**: 检查是否为系统接口
5. **关联数据检查**: 检查是否存在测试用例和前置条件
6. **使用状态检查**: 检查接口是否正在被使用
7. **执行软删除**: 更新接口状态为已删除
8. **记录日志**: 记录删除操作日志

### 权限规则
1. **创建者权限**: 可以删除自己创建的接口
2. **项目成员权限**: 项目成员可以删除接口
3. **接口管理权限**: 需要接口管理权限

### 软删除实现
- 设置 `is_deleted` 为 `TRUE`
- 设置 `deleted_at` 为当前时间
- 设置 `deleted_by` 为当前用户ID
- 设置 `status` 为 `inactive`

### 系统接口保护
1. **编码前缀**: 以 `SYS_` 开头的接口编码
2. **名称关键字**: 包含"系统"关键字的接口名称
3. **业务规则**: 系统接口不允许删除

### 关联数据检查
1. **测试用例检查**: 如果接口有测试用例，不允许删除
2. **前置条件检查**: 如果接口有前置条件，不允许删除
3. **使用状态检查**: 如果接口正在被使用，不允许删除

## 安全特性

### 1. 认证要求
- 使用`@GlobalInterceptor(checkLogin = true)`进行认证
- 必须提供有效的认证令牌

### 2. 权限控制
- 验证用户是否有接口管理权限
- 只能删除有权限的接口

### 3. 业务规则验证
- 系统接口保护
- 关联数据检查
- 使用状态检查

### 4. 软删除机制
- 数据不物理删除，保留审计信息
- 支持数据恢复和审计追踪

## 错误处理

### 错误码说明
| 错误码 | 含义 | HTTP状态码 |
|--------|------|------------|
| 1 | 成功 | 200 |
| 0 | 业务逻辑失败 | 200 |
| -1 | 认证失败 | 401 |
| -2 | 权限不足 | 200 |
| -3 | 参数校验失败 | 200 |
| -4 | 资源不存在 | 200 |
| -5 | 服务器内部异常 | 500 |

### 常见错误场景
1. **接口不存在**: 指定的接口ID不存在
2. **接口已删除**: 接口已经被软删除
3. **权限不足**: 用户没有接口管理权限
4. **系统接口**: 尝试删除系统接口
5. **存在关联数据**: 接口存在测试用例或前置条件
6. **正在被使用**: 接口正在被测试计划使用

## 数据库操作

### 软删除SQL
```sql
UPDATE Apis 
SET is_deleted = TRUE,
    deleted_at = NOW(),
    deleted_by = :current_user_id,
    status = 'inactive'
WHERE api_id = :api_id
  AND is_deleted = FALSE;
```

### 关联数据检查SQL
```sql
-- 检查测试用例
SELECT COUNT(*) FROM TestCases 
WHERE api_id = :api_id 
AND is_deleted = FALSE;

-- 检查前置条件
SELECT COUNT(*) FROM ApiPreconditions 
WHERE api_id = :api_id 
AND is_deleted = FALSE;
```

## 注意事项

1. **认证要求**: 此接口需要认证，请求头必须包含有效的 `Authorization` 字段
2. **权限检查**: 用户需要有接口管理权限
3. **软删除**: 采用软删除方式，数据不会物理删除
4. **关联数据**: 删除前必须检查关联数据，防止数据不一致
5. **系统接口**: 系统接口不允许删除
6. **审计日志**: 删除操作会记录详细的日志信息

## 级联删除策略

### 推荐策略：阻止删除
- 如果存在关联数据，阻止删除操作
- 确保数据一致性和完整性
- 避免误删重要数据

### 可选策略：级联删除
- 删除接口时，同时删除所有关联的测试用例和前置条件
- 需要谨慎使用，可能造成数据丢失

### 可选策略：转移归属
- 将测试用例和前置条件转移到其他接口
- 需要额外的业务逻辑处理

## 恢复功能

### 回收站机制
- 提供接口回收站功能
- 支持恢复已删除的接口
- 恢复时需要重新验证接口编码的唯一性

### 审计追踪
- 记录删除操作日志
- 包含操作人、时间、原因等信息
- 支持变更历史查询

## 性能优化

### 1. 索引优化
- 接口ID索引
- 删除状态索引
- 创建人索引

### 2. 查询优化
- 使用索引进行关联数据检查
- 批量检查减少数据库访问

### 3. 缓存策略
- 接口信息可以缓存
- 关联数据统计可以缓存

## 测试

可以使用提供的 `test_delete_api.bat` 脚本进行接口测试，或者使用 Postman 等工具进行测试。

测试前请确保：
1. 应用已启动
2. 数据库中有测试数据
3. 有有效的认证令牌
4. 有接口管理权限

## 后续扩展建议

1. **批量删除**: 支持批量删除接口
2. **强制删除**: 提供强制删除选项（忽略关联数据）
3. **删除确认**: 删除前需要二次确认
4. **权限细化**: 更细粒度的删除权限控制
5. **审计日志**: 记录详细的删除操作日志
6. **通知功能**: 删除后通知相关人员
7. **回收站**: 提供接口回收站功能
8. **恢复功能**: 支持恢复已删除的接口
9. **删除统计**: 提供删除统计信息
10. **删除审批**: 重要接口删除需要审批
11. **关联处理**: 删除时处理关联数据
12. **版本控制**: 支持接口版本管理
13. **删除原因**: 记录删除原因
14. **删除时间**: 支持定时删除
15. **删除策略**: 支持不同的删除策略
