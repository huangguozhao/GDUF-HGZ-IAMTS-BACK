# 项目统计接口实现说明

## 概述

为 `ProjectController` 添加了获取项目统计数据的接口，用于在前端展示项目的各项关键指标，提升用户体验。

## 接口详情

### 1. API 端点

```
GET /api/projects/{projectId}/statistics
```

### 2. 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| projectId | Integer | 是 | 项目ID（路径参数） |

### 3. 响应数据结构

```json
{
  "code": 0,
  "msg": "查询项目统计数据成功",
  "data": {
    "projectId": 1,
    "projectName": "PAMC Exchange Platform",
    "projectCode": null,
    "moduleCount": 12,
    "testCaseCount": 150,
    "passedCount": 120,
    "failedCount": 20,
    "notExecutedCount": 10,
    "apiCount": 45,
    "executionRecordCount": 85,
    "testReportCount": 30,
    "memberCount": 8,
    "passRate": 85.71,
    "lastExecutionTime": "2025-10-24 13:45:53",
    "createdAt": "2025-01-15 10:30:00",
    "updatedAt": "2025-10-24 12:00:00"
  }
}
```

### 4. 字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| projectId | Integer | 项目ID |
| projectName | String | 项目名称 |
| projectCode | String | 项目编码（当前为null，Project实体暂无此字段） |
| moduleCount | Integer | 模块总数（不包含已删除） |
| testCaseCount | Integer | 测试用例总数（仅启用的用例） |
| passedCount | Integer | 通过的测试用例数（基于最近的测试结果） |
| failedCount | Integer | 失败的测试用例数（包括 failed/error/broken） |
| notExecutedCount | Integer | 未执行的测试用例数（总数 - 已执行） |
| apiCount | Integer | 接口总数 |
| executionRecordCount | Integer | 测试执行记录总数 |
| testReportCount | Integer | 测试报告总数 |
| memberCount | Integer | 项目成员总数 |
| passRate | Double | 用例通过率（%，保留2位小数） |
| lastExecutionTime | String | 最近一次执行时间（格式：yyyy-MM-dd HH:mm:ss） |
| createdAt | String | 项目创建时间 |
| updatedAt | String | 项目最后更新时间 |

## 实现细节

### 1. 新增文件

- `src/main/java/com/victor/iatms/entity/dto/ProjectStatisticsDTO.java` - 统计数据DTO

### 2. 修改文件

#### Controller层
- `src/main/java/com/victor/iatms/controller/ProjectController.java`
  - 新增 `getProjectStatistics()` 方法

#### Service层
- `src/main/java/com/victor/iatms/service/ProjectService.java`
  - 新增 `getProjectStatistics()` 方法签名
  
- `src/main/java/com/victor/iatms/service/impl/ProjectServiceImpl.java`
  - 实现 `getProjectStatistics()` 方法
  - 添加 `TestExecutionMapper` 依赖注入

#### Mapper层
- `src/main/java/com/victor/iatms/mappers/ProjectMapper.java`
  - 新增 `selectByCode()` - 根据项目编码查询
  - 新增 `checkProjectCodeExists()` - 检查项目编码是否存在

- `src/main/java/com/victor/iatms/mappers/TestExecutionMapper.java`
  - 新增 `countPassedTestCasesByProjectId()` - 统计通过用例数
  - 新增 `countFailedTestCasesByProjectId()` - 统计失败用例数
  - 新增 `getLatestExecutionTimeByProjectId()` - 获取最近执行时间
  - 新增 `countExecutionRecordsByProjectId()` - 统计执行记录数

#### XML映射
- `src/main/resources/mapper/ProjectMapper.xml`
  - 添加 `selectByCode` SQL
  - 添加 `checkProjectCodeExists` SQL

- `src/main/resources/mapper/TestExecutionMapper.xml`
  - 添加 `countPassedTestCasesByProjectId` SQL
  - 添加 `countFailedTestCasesByProjectId` SQL
  - 添加 `getLatestExecutionTimeByProjectId` SQL
  - 添加 `countExecutionRecordsByProjectId` SQL

### 3. 统计逻辑说明

#### 通过率计算
```java
if (executedCount > 0) {
    double passRate = (passedCount * 100.0) / executedCount;
    statistics.setPassRate(Math.round(passRate * 100.0) / 100.0);
} else {
    statistics.setPassRate(0.0);
}
```

#### 未执行数计算
```java
int executedCount = passedCount + failedCount;
int notExecutedCount = testCaseCount - executedCount;
statistics.setNotExecutedCount(notExecutedCount > 0 ? notExecutedCount : 0);
```

## 前端使用示例

```javascript
// 获取项目统计数据
async function getProjectStatistics(projectId) {
  try {
    const response = await fetch(`/api/projects/${projectId}/statistics`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.code === 0) {
      const stats = result.data;
      
      // 更新UI
      document.getElementById('module-count').textContent = stats.moduleCount;
      document.getElementById('test-case-count').textContent = stats.testCaseCount;
      document.getElementById('passed-count').textContent = stats.passedCount;
      document.getElementById('failed-count').textContent = stats.failedCount;
      document.getElementById('not-executed-count').textContent = stats.notExecutedCount;
      document.getElementById('pass-rate').textContent = `${stats.passRate}%`;
      
      // 可以用于图表展示
      updateChart(stats);
    }
  } catch (error) {
    console.error('获取项目统计数据失败:', error);
  }
}
```

## 错误处理

| 错误场景 | HTTP状态码 | 错误信息 |
|----------|-----------|----------|
| 项目ID为空 | 400 | 项目ID不能为空 |
| 项目不存在 | 404 | 项目不存在 |
| 项目已删除 | 400 | 项目已被删除 |
| 系统异常 | 500 | 查询项目统计数据失败：{具体错误} |

## 性能优化建议

1. **缓存统计数据**
   - 统计数据变化不频繁，可以添加Redis缓存
   - 建议缓存时间：5-10分钟

2. **异步计算**
   - 对于大型项目，统计查询可能较慢
   - 可以考虑后台定时任务预计算统计数据

3. **索引优化**
   - 确保相关表的 `project_id` 字段有索引
   - `TestCaseResults.status` 字段建议添加索引

## 测试

运行测试脚本：
```bash
test_project_statistics.bat
```

## 后续优化方向

1. **添加时间范围筛选**
   - 支持查询指定时间范围内的统计数据
   - 例如：最近7天、最近30天的执行统计

2. **添加趋势数据**
   - 返回统计数据的变化趋势
   - 例如：通过率的周/月趋势

3. **添加更多维度**
   - 按模块分组的统计
   - 按测试类型分组的统计
   - 按优先级分组的统计

4. **导出功能**
   - 支持导出统计报告（PDF/Excel）

## 注意事项

1. Project实体当前没有 `projectCode` 字段，返回值为 `null`
2. 失败用例包括状态为 `failed`、`error`、`broken` 的用例
3. 通过率只计算已执行的用例（通过数 / (通过数 + 失败数)）
4. 所有统计都排除了已删除的数据

## 数据库表关联说明

### 表结构关系
- `Projects` ← `Modules` (module.project_id)
- `Modules` ← `Apis` (api.module_id)
- `Apis` ← `TestCases` (testcase.api_id)
- `TestCases` ← `TestCaseResults` (使用 `task_type='test_case'` AND `ref_id=case_id`)
- `TestExecutionRecords` 使用 `execution_scope` + `ref_id` 关联不同级别的数据

### 关键字段说明
1. **TestCaseResults 表**
   - 使用 `task_type` + `ref_id` 的灵活关联设计
   - `task_type='test_case'` 时，`ref_id` 指向 `TestCases.case_id`
   - `task_type='api_monitor'` 时，`ref_id` 指向 `Apis.api_id`
   - 其他类型同理

2. **TestExecutionRecords 表**
   - 使用 `execution_scope` + `ref_id` 的灵活关联设计
   - `execution_scope='project'` 时，`ref_id` 指向 `Projects.project_id`
   - `execution_scope='module'` 时，`ref_id` 指向 `Modules.module_id`
   - 其他类型同理

### SQL查询逻辑
1. **统计测试用例结果**：
   ```sql
   TestCaseResults (task_type='test_case', ref_id)
   → TestCases (case_id, api_id)
   → Apis (api_id, module_id)
   → Modules (module_id, project_id)
   → Projects
   ```

2. **统计执行记录**：
   ```sql
   TestExecutionRecords 
   WHERE execution_scope='project' AND ref_id=projectId
   ```

## 问题修复记录

### 2025-10-24 修复 #1

**问题**: `Unknown column 'tc.project_id' in 'where clause'`

**原因**: `TestCases` 表没有 `project_id` 字段，需要通过 `api_id` → `module_id` → `project_id` 关联

**解决方案**:
1. 修改 `countPassedTestCasesByProjectId` 和 `countFailedTestCasesByProjectId`，添加 `Apis` 和 `Modules` 表的 JOIN
2. 修改 `getLatestExecutionTimeByProjectId` 和 `countExecutionRecordsByProjectId`，使用 `execution_scope='project'` 筛选

### 2025-10-24 修复 #2

**问题**: `Unknown column 'tcr.case_id' in 'on clause'`

**原因**: `TestCaseResults` 表使用 `task_type` + `ref_id` 来关联数据，没有直接的 `case_id` 字段

**解决方案**:
修改 JOIN 条件从 `tcr.case_id = tc.case_id` 改为 `tcr.task_type = 'test_case' AND tcr.ref_id = tc.case_id`

**修改后的 SQL**:
```sql
SELECT COUNT(DISTINCT tcr.result_id)
FROM TestCaseResults tcr
INNER JOIN TestCases tc ON tcr.task_type = 'test_case' AND tcr.ref_id = tc.case_id
INNER JOIN Apis a ON tc.api_id = a.api_id
INNER JOIN Modules m ON a.module_id = m.module_id
WHERE m.project_id = #{projectId}
  AND tcr.status = 'passed'
  AND tc.is_deleted = 0
  AND tcr.is_deleted = 0
  AND a.is_deleted = 0
  AND m.is_deleted = 0
```

## 版本信息

- 实现日期：2025-10-24
- 实现人：AI Assistant
- 版本：v1.1 (修复了数据库表关联问题)

