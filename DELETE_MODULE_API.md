# 删除模块接口文档

## 接口概述

删除模块接口提供了安全删除指定模块的功能，采用软删除方式，包含完整的业务逻辑验证和权限检查。

## 接口详情

### 删除模块

**请求路径**: `/modules/{module_id}`  
**请求方式**: `DELETE`  
**接口描述**: 删除指定模块（软删除）

#### 请求参数

**请求头**:
- `Authorization` (string, 必须): 认证令牌，格式: `Bearer {token}`

**路径参数**:
- `module_id` (number, 必须): 要删除的模块ID

**请求体**: 无

#### 请求示例

```bash
# 删除模块
curl -X DELETE "http://localhost:8080/modules/1" \
  -H "Authorization: Bearer your_token_here"
```

#### 响应数据

**成功响应** (HTTP 200):

```json
{
  "code": 1,
  "msg": "模块删除成功",
  "data": null
}
```

**失败响应**:

```json
// 模块不存在 (HTTP 200)
{
  "code": -4,
  "msg": "模块不存在",
  "data": null
}

// 模块已被删除 (HTTP 200)
{
  "code": 0,
  "msg": "模块已被删除",
  "data": null
}

// 权限不足 (HTTP 200)
{
  "code": -2,
  "msg": "权限不足，无法删除模块",
  "data": null
}

// 模块存在子模块 (HTTP 200)
{
  "code": 0,
  "msg": "模块存在子模块，无法删除",
  "data": null
}

// 模块存在接口数据 (HTTP 200)
{
  "code": 0,
  "msg": "模块存在接口数据，无法删除",
  "data": null
}

// 不能删除系统模块 (HTTP 200)
{
  "code": 0,
  "msg": "不能删除系统模块",
  "data": null
}

// 模块正在被使用 (HTTP 200)
{
  "code": 0,
  "msg": "模块正在被使用，无法删除",
  "data": null
}
```

## 业务逻辑说明

### 删除流程
1. **参数校验**: 验证模块ID和删除人ID
2. **模块存在性检查**: 检查模块是否存在
3. **删除状态检查**: 检查模块是否已被删除
4. **系统模块检查**: 检查是否为系统模块（不允许删除）
5. **权限验证**: 检查用户是否有删除权限
6. **子模块检查**: 检查是否存在子模块
7. **接口数据检查**: 检查是否存在接口数据
8. **使用状态检查**: 检查模块是否正在被使用
9. **执行软删除**: 更新模块状态为已删除
10. **记录审计日志**: 记录删除操作

### 权限规则
1. **创建者权限**: 可以删除自己创建的模块
2. **管理员权限**: 管理员可以删除任何模块（待实现）
3. **系统模块保护**: 系统模块不允许删除

### 系统模块识别
- 模块编码以 `SYS_` 开头
- 模块名称包含"系统"关键字

### 使用状态检查
检查模块是否在以下场景中被使用：
- 测试用例中引用
- 测试套件中引用
- 测试计划中引用

## 安全特性

### 1. 软删除
- 不物理删除数据，只标记为已删除
- 保留数据完整性，支持数据恢复
- 记录删除时间和删除人

### 2. 权限控制
- 认证要求：必须提供有效令牌
- 权限验证：只能删除有权限的模块
- 系统保护：系统模块不允许删除

### 3. 业务规则验证
- 关联数据检查：防止数据不一致
- 使用状态检查：防止影响正在进行的操作
- 层级关系检查：防止破坏模块结构

### 4. 审计追踪
- 记录删除操作
- 记录删除人和时间
- 支持操作回滚

## 错误处理

### 错误码说明
| 错误码 | 含义 | HTTP状态码 |
|--------|------|------------|
| 1 | 成功 | 200 |
| 0 | 业务逻辑失败 | 200 |
| -1 | 认证失败 | 401 |
| -2 | 权限不足 | 200 |
| -3 | 参数校验失败 | 400 |
| -4 | 资源不存在 | 200 |
| -5 | 服务器内部异常 | 500 |

### 常见错误场景
1. **模块不存在**: 指定的模块ID不存在
2. **模块已删除**: 模块已经被软删除
3. **权限不足**: 用户没有删除权限
4. **存在子模块**: 模块下有子模块，不能删除
5. **存在接口数据**: 模块下有接口，不能删除
6. **正在被使用**: 模块正在被测试用例等使用
7. **系统模块**: 系统模块不允许删除

## 注意事项

1. **认证要求**: 此接口需要认证，请求头必须包含有效的 `Authorization` 字段
2. **权限检查**: 用户需要有模块删除权限
3. **软删除**: 删除操作是软删除，数据仍然保留在数据库中
4. **关联检查**: 删除前会检查所有关联数据，确保数据一致性
5. **系统保护**: 系统模块受到特殊保护，不允许删除
6. **审计日志**: 删除操作会被记录，支持审计追踪

## 级联删除策略

当前实现采用**阻止删除**策略：
- 如果存在子模块，阻止删除
- 如果存在接口数据，阻止删除
- 如果正在被使用，阻止删除

其他可选策略：
1. **级联删除**: 同时删除所有子模块和关联数据（危险）
2. **转移归属**: 将子模块和接口转移到其他模块

## 测试

可以使用提供的 `test_delete_module_api.bat` 脚本进行接口测试，或者使用 Postman 等工具进行测试。

测试前请确保：
1. 应用已启动
2. 数据库中有测试数据
3. 有有效的认证令牌
4. 有模块删除权限

## 后续扩展建议

1. **硬删除功能**: 提供物理删除功能（需要更高级权限）
2. **批量删除**: 支持批量删除多个模块
3. **删除确认**: 添加二次确认机制
4. **回收站**: 提供模块恢复功能
5. **权限细化**: 更细粒度的删除权限控制
6. **审计增强**: 更详细的审计日志记录
