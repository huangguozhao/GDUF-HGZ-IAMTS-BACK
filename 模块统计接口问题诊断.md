# 模块统计接口问题诊断和修复

## 问题描述
查询模块统计数据时返回错误：`{"code":-5,"msg":"查询模块统计数据失败：null"}`

## 问题分析

### 症状
从日志看：
1. ✅ 查询模块信息成功
2. ✅ 统计API数量成功 (`SELECT COUNT(*) FROM Apis WHERE module_id = ? AND is_deleted = FALSE`)
3. ✅ 统计子模块数成功 (`SELECT COUNT(*) FROM Modules WHERE parent_module_id = ? AND is_deleted = FALSE`)
4. ❌ 之后没有看到统计测试用例的SQL执行，直接返回错误

### 根本原因

**方法重载冲突**：`TestExecutionMapper` 接口中有两个同名方法 `countTestCasesByModuleId`：
- 第117行（原有）：`countTestCasesByModuleId(moduleId, priorityList, tagsList, enabledOnly)` - 4个参数
- 第587行（新增）：`countTestCasesByModuleId(moduleId)` - 1个参数（重复定义）

**MyBatis限制**：MyBatis 不支持真正的方法重载，XML 中的 `id` 必须唯一。

## 修复步骤

### 1. 删除重复的方法定义
**文件**：`src/main/java/com/victor/iatms/mappers/TestExecutionMapper.java`

删除了第587行的重复方法定义（1个参数的版本），保留第117行的完整定义（4个参数）。

### 2. 修正方法调用
**文件**：`src/main/java/com/victor/iatms/service/impl/ModuleServiceImpl.java`

```java
// 修改前（只传1个参数）
Integer testCaseCount = testExecutionMapper.countTestCasesByModuleId(moduleId);

// 修改后（传递完整的4个参数，不需要过滤时传null）
Integer testCaseCount = testExecutionMapper.countTestCasesByModuleId(moduleId, null, null, null);
```

### 3. 添加详细日志
在 `ModuleServiceImpl.getModuleStatistics()` 方法中添加了 try-catch 块和详细的 debug 日志，用于诊断每个统计步骤：
- 统计测试用例数量
- 统计通过/失败用例数
- 统计执行记录数
- 获取最近执行时间

### 4. 彻底清理和重新编译
```bash
mvn clean
mvn compile -DskipTests
```

## 已修改的文件清单

1. ✅ `src/main/java/com/victor/iatms/mappers/TestExecutionMapper.java` - 删除重复方法
2. ✅ `src/main/java/com/victor/iatms/service/impl/ModuleServiceImpl.java` - 修正调用参数，添加日志
3. ✅ `src/main/resources/mapper/TestExecutionMapper.xml` - 确保SQL映射正确
4. ✅ `模块统计接口实现说明.md` - 更新文档，记录问题修复历程

## 下一步操作

### 1. 重启应用
由于修改了 Mapper 接口和实现，需要重启 Spring Boot 应用：
```bash
# 停止当前应用（Ctrl+C）
# 重新启动
mvn spring-boot:run
```

或者如果使用 IDE，直接重启应用。

### 2. 测试接口
使用测试脚本验证：
```bash
test_single_module_stat.bat
```

或者直接使用 curl：
```bash
curl -X GET "http://localhost:8080/api/modules/1/statistics" \
  -H "Authorization: Bearer test-token-123" \
  -H "Accept: application/json"
```

### 3. 查看详细日志
如果仍然有问题，检查应用日志中的 DEBUG 信息：
- `开始统计模块1的测试用例数量`
- `模块1的测试用例总数: X`
- `开始统计模块1的通过/失败用例数`
- 等等...

如果出现异常，日志会显示具体的错误堆栈。

## 期望的成功响应

```json
{
  "code": 1,
  "msg": "查询模块统计数据成功",
  "data": {
    "moduleId": 1,
    "moduleName": "认证模块",
    "moduleCode": "AUTH",
    "status": "active",
    "apiCount": 5,
    "testCaseCount": 10,
    "passedCount": 8,
    "failedCount": 1,
    "notExecutedCount": 1,
    "childModuleCount": 0,
    "executionRecordCount": 5,
    "passRate": 88.89,
    "lastExecutionTime": "2025-10-24 17:30:00",
    "createdAt": "2025-10-19 10:39:36",
    "updatedAt": "2025-10-19 10:39:36"
  }
}
```

## 技术要点总结

### MyBatis 方法重载限制
- MyBatis Mapper 接口**不支持**真正的方法重载
- 即使 Java 允许方法重载（参数列表不同），MyBatis 的 XML 映射也要求每个方法有唯一的 `id`
- 解决方法：
  1. 为不同参数的方法使用不同的名字（如 `countTestCases` vs `countTestCasesByPriority`）
  2. 或者使用一个通用方法，不需要的参数传 `null`，在 XML 中用 `<if test>` 条件判断

### MyBatis 动态 SQL 中的 null 处理
```xml
<if test="priorityList != null and priorityList.size() > 0">
    <!-- 只有 priorityList 不为 null 且不为空时才添加此条件 -->
</if>
```
- 传 `null` 时，`<if test="xxx != null">` 条件不成立，该部分 SQL 不会被拼接
- 这是安全且符合预期的行为

## 版本历史

- v1.0 - 初始实现
- v1.1 - 修复 SQL 映射重复定义问题
- v1.2 - 修复方法重载冲突，添加详细日志（当前版本）


