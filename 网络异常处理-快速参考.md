# 网络异常处理 - 快速参考

## 🎯 核心机制

**当请求被测系统时发生网络异常（连接失败、超时等），系统会自动将该测试用例标记为失败（FAILED）。**

## 📋 支持的异常类型

| 错误类型 | 错误码 | 失败类型 | 常见原因 |
|---------|-------|---------|---------|
| 连接被拒绝 | -1 | CONNECTION_REFUSED | 被测系统未启动、端口错误 |
| 请求超时 | -2 | TIMEOUT | 响应缓慢、网络延迟、超时设置过短 |
| 未知主机 | -3 | UNKNOWN_HOST | 主机名错误、DNS无法解析 |
| URL格式错误 | -4 | MALFORMED_URL | URL格式不规范、缺少协议 |
| 协议错误 | -5 | PROTOCOL_ERROR | HTTP方法不支持 |
| SSL证书错误 | -6 | SSL_ERROR | 证书无效、不受信任 |
| 网络IO错误 | -7 | IO_ERROR | 连接中断、传输失败 |
| 未知错误 | -99 | UNKNOWN_ERROR | 其他未预期错误 |

## 🔄 处理流程

```
发送HTTP请求
    ↓
捕获异常（ConnectException、SocketTimeoutException等）
    ↓
返回带错误信息的响应（statusCode=-1到-99）
    ↓
检查 response.hasError()
    ↓
设置测试状态为FAILED
    ↓
确定失败类型（CONNECTION_REFUSED、TIMEOUT等）
    ↓
生成详细错误日志
    ↓
保存到数据库
    ↓
返回失败结果
```

## 💾 数据库记录

### TestCaseResults表字段

```sql
status = 'failed'
failure_type = 'CONNECTION_REFUSED'  -- 或其他类型
failure_message = '连接被拒绝: 无法连接到 http://localhost:8085/...'
http_response_status = -1  -- 错误码
http_response_body = null
execution_logs = '详细的错误日志...'
```

### 统计更新

```sql
-- TestExecutionRecords表
failed_cases = failed_cases + 1
executed_cases = executed_cases + 1
success_rate = (passed_cases / total_cases * 100)
```

## 📄 错误日志示例

```
=== 网络错误执行日志 ===
用例ID: 1
用例名称: 正常登录测试

=== 请求信息 ===
请求方法: POST
请求URL: http://localhost:8085/api/auth/login
超时设置: 30秒

=== 错误信息 ===
错误类型: CONNECTION_REFUSED
错误代码: -1
错误信息: 连接被拒绝: 无法连接到 http://localhost:8085/api/auth/login

=== 失败说明 ===
连接被拒绝，可能原因：
  1. 被测系统未启动或已停止
  2. 被测系统端口不正确
  3. 防火墙阻止了连接
  建议：检查被测系统是否正在运行，确认URL和端口配置是否正确
```

## 🔧 代码示例

### HttpClientUtils.java - 捕获异常

```java
try {
    // 发送HTTP请求
    int responseCode = connection.getResponseCode();
    return new HttpResponseResult(responseCode, body, headers, null);
    
} catch (ConnectException e) {
    return new HttpResponseResult(-1, null, null, 
        "连接被拒绝: 无法连接到 " + url);
        
} catch (SocketTimeoutException e) {
    return new HttpResponseResult(-2, null, null, 
        "请求超时: 等待响应超过" + timeout + "秒");
}
```

### TestCaseExecutor.java - 处理错误

```java
// 检查网络错误
if (response.hasError()) {
    // 标记为失败
    executionDTO.setExecutionStatus(ExecutionStatusEnum.FAILED.getCode());
    executionDTO.setFailureMessage(response.getErrorMessage());
    
    // 确定失败类型
    String failureType = determineFailureType(response.getStatusCode());
    executionDTO.setFailureType(failureType);
    
    // 生成错误日志
    String errorLog = generateNetworkErrorLog(...);
    executionDTO.setExecutionLogs(errorLog);
    
    return executionDTO;
}
```

## 📊 API响应示例

```json
{
  "code": 0,
  "msg": "接口测试执行完成",
  "data": {
    "totalCases": 5,
    "passed": 3,
    "failed": 2,
    "caseResults": [
      {
        "caseId": 1,
        "caseName": "正常登录测试",
        "status": "failed",
        "failureMessage": "连接被拒绝: 无法连接到 http://localhost:8085/api/auth/login，请检查被测系统是否启动",
        "duration": 0
      }
    ]
  }
}
```

## ⚙️ 超时配置

### 优先级

```
测试用例超时 > 接口超时 > 全局默认超时（30秒）
```

### 推荐值

- **快速接口**：10秒
- **普通接口**：30秒（默认）
- **慢接口**：60秒
- **特殊场景**：最长120秒

## 🔍 常见问题

### 1. 频繁超时
**解决：** 增加超时时间，或检查被测系统性能

### 2. 全部连接失败
**解决：** 检查被测系统是否启动，确认URL和端口配置

### 3. SSL证书错误
**解决：** 使用有效的SSL证书，或在测试环境禁用SSL验证

## ✅ 修改的文件

1. **HttpClientUtils.java**
   - 增强异常捕获，详细分类各种网络错误
   - 为每种异常提供清晰的错误信息

2. **TestCaseExecutor.java**
   - 添加`determineFailureType()`方法
   - 增强`generateNetworkErrorLog()`方法
   - 添加`getFailureExplanation()`方法

## 🎓 设计原则

- ✅ **自动捕获**：所有网络异常都会被自动捕获
- ✅ **详细分类**：8种常见网络错误类型
- ✅ **清晰日志**：提供详细的错误日志和失败说明
- ✅ **准确统计**：失败的测试正确计入统计
- ✅ **易于排查**：提供可能原因和解决建议

---

**详细文档：** 参见 `网络异常处理机制说明.md`

